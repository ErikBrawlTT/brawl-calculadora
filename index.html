<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora Brawl Stars - Debuggable</title>

<!-- Librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Tu CSS (respetado) -->
<style>
  body { margin:0; font-family:'Bangers', cursive; background:url('Personajes-Brawl-Stars.webp') no-repeat center center fixed; background-size:cover; color:white; text-align:center; position:relative;}
  body::after{content:"";position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);z-index:0;}
  .container{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
  h1{font-size:3rem;margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:10px;color:transparent;background:linear-gradient(90deg,#00FFAA,#00CFFF,#FF00FF);-webkit-background-clip:text;}
  .diamond{animation:glow 3s infinite alternate;} @keyframes glow{0%{text-shadow:0 0 5px rgba(255,255,255,.5)}50%{text-shadow:0 0 15px rgba(255,255,255,1)}100%{text-shadow:0 0 5px rgba(255,255,255,.5)}}
  form{background:rgba(0,0,0,.5);border-radius:60px;padding:20px;max-width:600px;width:90%;margin-bottom:25px;display:flex;flex-direction:column;align-items:center;}
  label{display:flex;justify-content:space-between;margin:8px 0;width:100%}
  input{width:100px;text-align:center;border:none;border-radius:8px}
  .buttons{display:flex;justify-content:center;gap:25px;margin-top:15px}
  button{padding:10px 20px;border:none;border-radius:12px;font-family:'Bangers';font-size:1.5rem;color:white;cursor:pointer}
  #calcBtn{background:linear-gradient(90deg,#ff0080,#7928ca)} #clearBtn{background:linear-gradient(90deg,#00CFFF,#0077FF)} #shareBtn{background:linear-gradient(90deg,#00FFAA,#FF00FF);margin-top:20px;animation:pulse 1s infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
  #resultado{margin-top:20px;font-size:2rem;font-family:'Bangers';padding:10px 20px;background:rgba(0,0,0,.7);border:2px solid #00FF00;border-radius:12px;color:#00FF00;text-shadow:0 0 10px #00FF00,0 0 20px #00FF00}
  .countersRow{display:flex;justify-content:center;gap:30px;margin:15px 0}
  .counterBox{display:flex;flex-direction:column;align-items:center}
  .counterBox span{font-family:'Orbitron',sans-serif;font-size:2rem;padding:8px 18px;background:rgba(0,0,0,.7);border-radius:12px;border:2px solid #00CFFF;color:#00CFFF;text-shadow:0 0 8px #00CFFF;min-width:70px;text-align:center}
  canvas{margin-top:15px;max-width:400px;position:relative}
  #centerDiamond{position:absolute;top:43%;left:50%;transform:translate(-50%,-50%);display:none}
  #centerDiamond img{width:210px;height:210px;border-radius:50%;object-fit:contain;background:rgba(0,0,0,.3)}
  /* Panel de debug (peque√±o, aparece si hay errores) */
  #debugPanel{position:fixed;right:12px;bottom:12px;max-width:360px;z-index:9999;background:rgba(0,0,0,0.85);color:#fff;padding:10px;border-radius:8px;font-family:monospace;font-size:13px;display:none;border:2px solid #ff6666}
  #debugPanel h4{margin:0 0 6px 0;color:#ff8888}
  #debugLog{max-height:180px;overflow:auto}
</style>
</head>
<body>
  <div class="container">
    <h1><span class="diamond">üíé</span> Calculadora Brawl Stars <span class="diamond">üíé</span></h1>

    <form id="calcForm">
      <label>üéüÔ∏è Brawl Pass: <input type="number" id="bpass" value="0"></label>
      <label>ü©µ Comunes: <input type="number" id="comunes" value="0"></label>
      <label>üíö Raras: <input type="number" id="raras" value="0"></label>
      <label>üíú √âpicas: <input type="number" id="epicas" value="0"></label>
      <label>‚ù§Ô∏è M√≠ticas: <input type="number" id="miticas" value="0"></label>
      <label>üåü Legendarias: <input type="number" id="legendarias" value="0"></label>
      <label>‚ö° Hipercarga: <input type="number" id="hipercarga" value="0"></label>
      <label>üî• Maxeados: <input type="number" id="maxeados" value="0"></label>
    </form>

    <div class="buttons">
      <button id="calcBtn" type="button">Calcular</button>
      <button id="clearBtn" type="button">Limpiar</button>
    </div>
    <button id="shareBtn" type="button">üì§ Compartir</button>

    <div class="countersRow">
      <div class="counterBox">üëÄ Visitas: <span id="visitas">0</span></div>
      <div class="counterBox"><button id="likeBtn" type="button">‚ù§Ô∏è</button> Likes: <span id="likes">0</span></div>
      <div class="counterBox"><button id="dislikeBtn" type="button">üëé</button> No me gusta: <span id="dislikes">0</span></div>
    </div>

    <div id="resultado">Valor total: 0 ‚Ç¨</div>

    <div style="position:relative; display:inline-block;">
      <canvas id="myChart" width="400" height="400"></canvas>
      <div id="centerDiamond"><img id="brawlerImg" src="https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/elprimo.png" alt="Brawler"></div>
    </div>
  </div>

  <!-- Panel debug -->
  <div id="debugPanel">
    <h4>Debug Supabase</h4>
    <div id="debugLog"></div>
  </div>

<script>
/* ---------------- CONFIGURA AQUI ---------------- */
const SUPABASE_URL = "https://yvciudpdvylmplpbfobo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2Y2l1ZHBkdnlsbXBscGJmb2JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODE5MTksImV4cCI6MjA3MTQ1NzkxOX0.kzMHyDj2A1Df5P0qJVdXdol8gkmnxmELYmad9gQX_WI"; // <- reemplaza con tu anon key si quieres
/* ------------------------------------------------ */

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const dbg = {
  show: (msg, isErr=false)=>{
    const panel = document.getElementById('debugPanel');
    const log = document.getElementById('debugLog');
    panel.style.display = 'block';
    const line = document.createElement('div');
    line.style.padding = '4px 0';
    line.style.borderTop = '1px dashed rgba(255,255,255,0.06)';
    line.innerText = (isErr? '‚ùó ':'') + msg;
    log.prepend(line);
    console.log(msg);
  },
  hide: ()=>{ document.getElementById('debugPanel').style.display = 'none'; }
};

let counterRowId = null; // valor real de id en la tabla (puede ser "main" o 1)
let chart = null;

/* Helper: intenta obtener una fila de counters de varias formas */
async function findOrCreateRow() {
  try {
    // 1) buscar id = "main" (texto)
    let res = await supabase.from('counters').select('*').eq('id', 'main').maybeSingle();
    if (res.error) dbg.show('error leyendo id="main": ' + res.error.message, true);
    if (res.data) { dbg.show('Fila encontrada id="main"'); counterRowId = res.data.id; return res.data; }

    // 2) buscar id = 1 (integer)
    res = await supabase.from('counters').select('*').eq('id', 1).maybeSingle();
    if (res.error) dbg.show('error leyendo id=1: ' + res.error.message, true);
    if (res.data) { dbg.show('Fila encontrada id=1'); counterRowId = res.data.id; return res.data; }

    // 3) tomar la primera fila si existe
    res = await supabase.from('counters').select('*').limit(1).maybeSingle();
    if (res.error) dbg.show('error leyendo primera fila: ' + res.error.message, true);
    if (res.data) { dbg.show('Usando primera fila encontrada con id='+res.data.id); counterRowId = res.data.id; return res.data; }

    // 4) no hay filas -> intentar crear con id = "main" (si falla, intentar con id = 1)
    dbg.show('No se encontr√≥ fila en counters. Intentando crear id="main"...');
    let ins = await supabase.from('counters').insert([{ id: 'main', visitas: 0, likes: 0, dislikes: 0 }]).select().maybeSingle();
    if (ins.error) {
      dbg.show('Insert id="main" fall√≥: ' + ins.error.message, true);
      dbg.show('Intentando insert con id=1 (integer)...');
      ins = await supabase.from('counters').insert([{ id: 1, visitas: 0, likes: 0, dislikes: 0 }]).select().maybeSingle();
      if (ins.error) {
        dbg.show('Insert id=1 fall√≥: ' + ins.error.message, true);
        dbg.show('No se pudo crear fila autom√°ticamente. Crea manualmente la fila en Supabase (ver abajo).', true);
        return null;
      } else {
        dbg.show('Fila creada con id=1');
        counterRowId = ins.data.id;
        return ins.data;
      }
    } else {
      dbg.show('Fila creada con id="main"');
      counterRowId = ins.data.id;
      return ins.data;
    }
  } catch (err) {
    dbg.show('Excepci√≥n en findOrCreateRow: ' + err.message, true);
    console.error(err);
    return null;
  }
}

/* Cargar contadores al inicio */
async function cargarContadores() {
  try {
    if (!counterRowId) {
      dbg.show('counterRowId no est√° definido en cargarContadores()', true);
      return;
    }
    const res = await supabase.from('counters').select('visitas, likes, dislikes').eq('id', counterRowId).maybeSingle();
    if (res.error) { dbg.show('Error cargarContadores: ' + res.error.message, true); return; }
    const d = res.data;
    if (!d) { dbg.show('No hay datos en cargarContadores()', true); return; }
    document.getElementById('visitas').innerText = d.visitas ?? 0;
    document.getElementById('likes').innerText = d.likes ?? 0;
    document.getElementById('dislikes').innerText = d.dislikes ?? 0;
    dbg.show('Contadores cargados: visitas=' + (d.visitas||0) + ' likes=' + (d.likes||0) + ' dislikes=' + (d.dislikes||0));
  } catch (err) {
    dbg.show('Excepci√≥n cargarContadores: ' + err.message, true);
  }
}

/* Incrementador gen√©rico (usa counterRowId detectado) */
async function incrementarCampo(campo) {
  try {
    if (!counterRowId) { dbg.show('No hay fila para actualizar (counterRowId vac√≠o).', true); return; }

    // Leer valor actual
    const sel = await supabase.from('counters').select(campo).eq('id', counterRowId).maybeSingle();
    if (sel.error) { dbg.show('Error al leer ' + campo + ': ' + sel.error.message, true); return; }
    const current = Number(sel.data?.[campo] ?? 0);
    const nuevo = current + 1;

    // Actualizar
    const upd = await supabase.from('counters').update({ [campo]: nuevo }).eq('id', counterRowId).select().maybeSingle();
    if (upd.error) {
      dbg.show('Error al actualizar ' + campo + ': ' + upd.error.message, true);
      // Si es "permission denied" sugiere RLS
      if (upd.error.message && upd.error.message.toLowerCase().includes('permission')) {
        dbg.show('Pista: puede ser RLS (Row Level Security). Aseg√∫rate de crear una policy que permita updates para el rol anon o desactiva RLS para pruebas.', true);
      }
      return;
    }
    document.getElementById(campo).innerText = nuevo;
    dbg.show('Campo actualizado: ' + campo + ' = ' + nuevo);
  } catch (err) {
    dbg.show('Excepci√≥n incrementarCampo(' + campo + '): ' + err.message, true);
  }
}

/* --- Funciones p√∫blicas que usa la UI --- */
async function sumarVisita() { await incrementarCampo('visitas'); }
async function sumarLike() { await incrementarCampo('likes'); }
async function sumarDislike() { await incrementarCampo('dislikes'); }

/* ---------------- Resto de tu c√≥digo (calculadora, confeti, gr√°fico, brawlers) ---------------- */
function lanzarConfeti() {
  const duration = 4000;
  const end = Date.now() + duration;
  (function frame() {
    confetti({ particleCount: 10, startVelocity: 3, gravity: 0.25, spread: 360, ticks: 200, origin: { x: Math.random(), y: Math.random() * 0.4 }, colors: ['#ff00ff','#00ffff','#00ff00','#ffff00','#ff0000','#00CFFF'] });
    if (Date.now() < end) requestAnimationFrame(frame);
  })();
}
function beep(freq){ const ctx=new (AudioContext||webkitAudioContext)(), o=ctx.createOscillator(), g=ctx.createGain(); o.type='square'; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(.15, ctx.currentTime); o.start(); o.stop(ctx.currentTime+.15); }
function vibrar(ms=80){ if(navigator.vibrate) navigator.vibrate(ms); }
function animateNumber(finalValue){
  const resultado = document.getElementById("resultado");
  const start = 0, duration = 2000, startTime = performance.now();
  function step(now) {
    const p = Math.min((now - startTime) / duration, 1);
    resultado.innerText = "Valor total: " + Math.floor(start + (finalValue - start) * p) + " ‚Ç¨";
    if (p < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

let chart;
function calcular(){
  beep(600); vibrar(80);
  function safeInt(id) { const v = parseInt(document.getElementById(id).value); return isNaN(v) ? 0 : v; }
  const bpass = safeInt('bpass'), comunes = safeInt('comunes'), raras = safeInt('raras'), epicas = safeInt('epicas'), miticas = safeInt('miticas'), legendarias = safeInt('legendarias'), hipercarga = safeInt('hipercarga'), maxeados = safeInt('maxeados');

  const valores = {
    "üéüÔ∏è Brawl Pass": bpass * 10,
    "ü©µ Comunes": comunes * 2,
    "üíö Raras": raras * 5,
    "üíú √âpicas": epicas * 10,
    "‚ù§Ô∏è M√≠ticas": miticas * 12,
    "üåü Legendarias": legendarias * 15,
    "‚ö° Hipercarga": hipercarga * 20,
    "üî• Maxeados": maxeados * 50
  };
  const total = Object.values(valores).reduce((a,b)=>a+b,0);
  animateNumber(total);
  document.getElementById("centerDiamond").style.display = "block";

  const data = { labels: Object.keys(valores), datasets: [{ data: Object.values(valores), backgroundColor: ["#00FFFF","#00FF00","#FF00FF","#FFFF00","#FF4500","#00CFFF","#FF69B4","#FF0000"], borderWidth: 2 }] };
  const config = { type: 'doughnut', data, options: { cutout: "70%", plugins: { legend: { display: true, position: 'bottom' } } } };
  if (chart) chart.destroy();
  const ctx = document.getElementById('myChart').getContext('2d');
  chart = new Chart(ctx, config);
  lanzarConfeti();
  document.getElementById('myChart').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function limpiar(){
  document.getElementById("calcForm").reset();
  document.getElementById("resultado").innerText = "Valor total: 0 ‚Ç¨";
  if (chart) chart.destroy();
  document.getElementById("centerDiamond").style.display = "none";
}

/* ----------------- Eventos UI ----------------- */
document.getElementById('calcBtn').addEventListener('click', async (e) => { e.preventDefault(); calcular(); /* opcional: sumar visita s√≥lo al entrar o tambi√©n al calcular */ });
document.getElementById('clearBtn').addEventListener('click', (e)=>{ e.preventDefault(); limpiar(); });
document.getElementById('likeBtn').addEventListener('click', async ()=> { await sumarLike(); });
document.getElementById('dislikeBtn').addEventListener('click', async ()=> { await sumarDislike(); });
document.getElementById('shareBtn').addEventListener('click', async ()=> {
  const url = window.location.href;
  const text = "Mira cu√°nto valen mis Brawlers en Brawl Stars!";
  if (navigator.share) { try { await navigator.share({ title: "Calculadora Brawl Stars", text, url }); } catch(err) { dbg.show('Compartir cancelado: '+err.message); } }
  else alert('Tu navegador no soporta compartir nativo.');
});

/* ----------------- Brawlers ----------------- */
const brawlers = ["https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/elprimo.png","https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/colt.png","https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/nita.png","https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/edgar.png","https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/spike.png","https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/penny.png","https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/darryl.png","https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/rico.png","https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/mortis.png","https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/bea.png"];
let current = 0;
const brawlerImg = document.getElementById("brawlerImg");
document.getElementById("centerDiamond").style.display="block";
setInterval(()=>{ current=(current+1)%brawlers.length; brawlerImg.src=brawlers[current]; }, 3000);

/* ----------------- Inicializaci√≥n ----------------- */
(async function init(){
  dbg.show('Iniciando: comprobando fila counters...');
  const row = await findOrCreateRow();
  if (!row) {
    dbg.show('No se pudo asegurar la fila counters. Revisa permisos y estructura de tabla.', true);
    return;
  }
  dbg.show('Fila de contadores lista. id=' + counterRowId);
  await cargarContadores();
  // incrementa visita al entrar:
  await sumarVisita();
})();
</script>
</body>
</html>
