canvas{margin-top:15px;max-width:400px;position:relative;}
/* 💎 Diamante central */
#centerDiamond {
  position: absolute;
  font-size: 60px;
  display: none;
  color: cyan;
  text-shadow: 0 0 15px cyan;
  transform-origin: center center;
}
</style>
</head>
<body>
<div class="container">
  <h1><span class="diamond">💎</span> Calculadora Brawl Stars <span class="diamond">💎</span></h1>

  <form id="calcForm">
    <label>🎟️ Brawl Pass: <input type="number" id="bpass" value="0"></label>
    <label>🩵 Comunes: <input type="number" id="comunes" value="0"></label>
    <label>💚 Raras: <input type="number" id="raras" value="0"></label>
    <label>💜 Épicas: <input type="number" id="epicas" value="0"></label>
    <label>❤️ Míticas: <input type="number" id="miticas" value="0"></label>
    <label>🌟 Legendarias: <input type="number" id="legendarias" value="0"></label>
    <label>⚡ Hipercarga: <input type="number" id="hipercarga" value="0"></label>
    <label>🔥 Maxeados: <input type="number" id="maxeados" value="0"></label>
  </form>

  <div class="buttons">
    <button id="calcBtn">Calcular</button>
    <button id="clearBtn">Limpiar</button>
  </div>

  <button id="shareBtn">📤 Compartir</button>

  <div id="resultado">Valor total: 0 €</div>
  <div class="visitas">👀 Visitas: <span id="visitas">0</span></div>

  <div style="position:relative; display:inline-block;">
    <canvas id="myChart" width="400" height="400"></canvas>
    <div id="centerDiamond">💎</div>
  </div>
</div>

<script>
// Contador de visitas
let visitas = localStorage.getItem("visitas") || 0;
visitas++; 
localStorage.setItem("visitas", visitas);
document.getElementById("visitas").innerText = visitas;

// Confeti
function lanzarConfeti() {
  const duration = 4000;
  const end = Date.now() + duration;
  (function frame() {
    confetti({
      particleCount: 10,
      startVelocity: 3,
      gravity: 0.25,
      spread: 360,
      ticks: 200,
      origin: { x: Math.random(), y: Math.random() * 0.4 },
      colors: ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff']
    });
    if (Date.now() < end) requestAnimationFrame(frame);
  })();
}

// Sonido y vibración
function beep(freq){const ctx=new (AudioContext||webkitAudioContext)(),o=ctx.createOscillator(),g=ctx.createGain();o.type="square";o.frequency.value=freq;o.connect(g);g.connect(ctx.destination);g.gain.setValueAtTime(.15,ctx.currentTime);o.start();o.stop(ctx.currentTime+.15);}
function vibrar(ms=80){if(navigator.vibrate)navigator.vibrate(ms);}

// Animar número
function animateNumber(finalValue){
  const resultado = document.getElementById("resultado");
  const start=0,duration=2000,startTime=performance.now();
  function step(now){
    const p=Math.min((now-startTime)/duration,1);
    resultado.innerText="Valor total: "+Math.floor(start+(finalValue-start)*p)+" €";
    if(p<1)requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// Gráfico
let chart;
function calcular(){
  beep(600); vibrar(80);
  const bpass = document.getElementById("bpass").value || 0;
  const comunes = document.getElementById("comunes").value || 0;
  const raras = document.getElementById("raras").value || 0;
  const epicas = document.getElementById("epicas").value || 0;
  const miticas = document.getElementById("miticas").value || 0;
  const legendarias = document.getElementById("legendarias").value || 0;
  const hipercarga = document.getElementById("hipercarga").value || 0;
  const maxeados = document.getElementById("maxeados").value || 0;

  const valores={
    "🎟️ Brawl Pass":bpass*10,
    "🩵 Comunes":comunes*2,
    "💚 Raras":raras*5,
    "💜 Épicas":epicas*10,
    "❤️ Míticas":miticas*12,
    "🌟 Legendarias":legendarias*15,
    "⚡ Hipercarga":hipercarga*20,
    "🔥 Maxeados":maxeados*50
  };
  const total = Object.values(valores).reduce((a,b)=>a+b,0);
  animateNumber(total);

  // Mostrar SIEMPRE el diamante
  const diamond = document.getElementById("centerDiamond");
  diamond.style.display="block";
  startDiamondBounce();

  const data={
    labels:Object.keys(valores),
    datasets:[{
      data:Object.values(valores),
      backgroundColor:["#1E90FF","#00CED1","#32CD32","#BA55D3","#FF4500","#FFD700","#FF69B4","#FF0000"],
      borderWidth:2
    }]
  };

  const config={
    type:'doughnut',
    data:data,
    options:{
      cutout:"50%", // 🔽 agujero más pequeño
      plugins:{legend:{display:true,position:'bottom'}}
    }
  };

  if(chart){chart.destroy();}
  const ctx = document.getElementById('myChart').getContext('2d');
  chart = new Chart(ctx,config);

  lanzarConfeti();
}

// Animación de rebote dentro del agujero central
let diamondInterval;
function startDiamondBounce(){
  stopDiamondBounce();
  const diamond=document.getElementById("centerDiamond");
  const canvas=document.getElementById("myChart");
  const size=canvas.width;
  const center=size/2;
  const radius=55; // ajustado al agujero más pequeño
  let angleX=0,angleY=0,vx=2,vy=3,rotation=0;

  function animate(){
    angleX+=vx; angleY+=vy;

    if(angleX<-radius || angleX>radius) vx*=-1;
    if(angleY<-radius || angleY>radius) vy*=-1;

    rotation+=10;
    diamond.style.left=(center+angleX-30)+"px"; 
    diamond.style.top=(center+angleY-30)+"px";
    diamond.style.transform=`rotate(${rotation}deg)`;
    diamond.style.color="hsl("+Math.floor(Math.random()*360)+",100%,50%)";
    diamond.style.textShadow=`0 0 15px ${diamond.style.color}`;
  }
  diamondInterval=setInterval(animate,40);
}
function stopDiamondBounce(){
  if(diamondInterval)clearInterval(diamondInterval);
}

// Limpiar
function limpiar(){
  document.getElementById("calcForm").reset();
  document.getElementById("resultado").innerText="Valor total: 0 €";
  if(chart){chart.destroy();}
  stopDiamondBounce();
  document.getElementById("centerDiamond").style.display="none";
}

// Botón compartir
document.getElementById("shareBtn").addEventListener("click", async () => {
  const url = window.location.href;
  const text = "Mira cuánto valen mis Brawlers en Brawl Stars!";
  if (navigator.share) {
    try {
      await navigator.share({ title: "Calculadora Brawl Stars", text: text, url: url });
    } catch (err) { console.log("Cancelado", err); }
  } else {
    alert("Tu navegador no soporta compartir nativo.");
  }
});

document.getElementById("calcBtn").addEventListener("click",calcular);
document.getElementById("clearBtn").addEventListener("click",limpiar);
</script>
</body>
</html>
