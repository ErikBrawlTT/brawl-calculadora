<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calculadora Brawl Stars</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<style>
body {margin:0;font-family:'Bangers',cursive;background:url('Personajes-Brawl-Stars.webp') no-repeat center center fixed;background-size:cover;color:white;text-align:center;position:relative}
body::after {content:"";position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:0;pointer-events:none}
.container {position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px}
h1 {font-size:3rem;margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:10px;color:transparent;background:linear-gradient(90deg,#00FFAA,#00CFFF,#FF00FF);-webkit-background-clip:text}
h1 .diamond {animation:glow 3s infinite alternate}
@keyframes glow {0%{text-shadow:0 0 5px rgba(255,255,255,.5)}50%{text-shadow:0 0 15px rgba(255,255,255,1)}100%{text-shadow:0 0 5px rgba(255,255,255,.5)}}
form {background:rgba(0,0,0,.5);border-radius:60px;padding:20px;max-width:600px;width:90%;margin-bottom:15px;display:flex;flex-direction:column;align-items:center}
label {display:flex;justify-content:space-between;margin:8px 0;width:100%}
input {width:100px;text-align:center;border:none;border-radius:8px}
.buttons {display:flex;justify-content:center;gap:25px;margin-top:15px}
button {padding:10px 20px;border:none;border-radius:12px;font-family:'Bangers';font-size:1.5rem;color:white;cursor:pointer;transition:transform .08s ease}
button:active {transform:scale(.97)}
button.flash {box-shadow:0 0 20px #fff,0 0 30px #fff,0 0 40px #fff;transition:box-shadow .2s ease}
#calcBtn {background:linear-gradient(90deg,#ff0080,#7928ca)}
#clearBtn {background:linear-gradient(90deg,#00CFFF,#0077FF)}
#shareBtn {background:linear-gradient(90deg,#00FFAA,#FF00FF);margin-top:20px;color:white}
.metric-container {display:flex;justify-content:center;gap:22px;margin-top:18px}
.metric {display:flex;flex-direction:column;align-items:center;gap:6px;font-family:'Orbitron',sans-serif;font-size:2rem}
.metric .box {background:rgba(0,0,0,.7);padding:8px 18px;border-radius:12px;min-width:70px;text-align:center;font-weight:700;user-select:none;transition:all .2s ease;cursor:pointer}
.metric.visitas .box {border:2px solid #00CFFF;color:#00CFFF;box-shadow:0 0 10px #00CFFF,0 0 20px #00CFFF}
.metric.likes .box {border:2px solid #39ff14;color:#39ff14;box-shadow:0 0 10px #39ff14,0 0 20px #39ff14}
.metric.dislikes .box {border:2px solid #FF073A;color:#FF073A;box-shadow:0 0 10px #FF073A,0 0 20px #FF073A}
canvas {margin-top:15px;max-width:400px;position:relative}
#centerDiamond {position:absolute;top:43%;left:50%;transform:translate(-50%,-50%);display:none}
#centerDiamond img {width:210px;height:210px;border-radius:50%;object-fit:contain;background:rgba(0,0,0,.3)}
#resultado {margin:10px 0;font-size:2rem;font-family:'Bangers';color:#00FF00;text-shadow:0 0 8px #00FF00,0 0 15px #00FF00}
</style>
</head>
<body>
<div class="container">
<h1><span class="diamond">üíé</span> Calculadora Brawl Stars <span class="diamond">üíé</span></h1>
<form id="calcForm">
<label>üéüÔ∏è Brawl Pass: <input type="number" id="bpass" value="0" min="0"></label>
<label>ü©µ Comunes: <input type="number" id="comunes" value="0" min="0"></label>
<label>üíö Raras: <input type="number" id="raras" value="0" min="0"></label>
<label>üíú √âpicas: <input type="number" id="epicas" value="0" min="0"></label>
<label>‚ù§Ô∏è M√≠ticas: <input type="number" id="miticas" value="0" min="0"></label>
<label>üåü Legendarias: <input type="number" id="legendarias" value="0" min="0"></label>
<label>‚ö° Hipercarga: <input type="number" id="hipercarga" value="0" min="0"></label>
<label>üî• Maxeados: <input type="number" id="maxeados" value="0" min="0"></label>
</form>
<div id="resultado">Valor total: 0 ‚Ç¨</div>
<div class="buttons">
<button type="button" id="calcBtn">Calcular</button>
<button type="button" id="clearBtn">Limpiar</button>
</div>
<button type="button" id="shareBtn">üì§ Compartir</button>
<div class="metric-container">
<div class="metric visitas"><span class="icon">üëÄ</span><div class="box" id="visitas-counter">0</div></div>
<div class="metric likes"><span class="icon">üëç</span><div class="box" id="likes-counter">0</div></div>
<div class="metric dislikes"><span class="icon">üëé</span><div class="box" id="dislikes-counter">0</div></div>
</div>
<div style="position:relative; display:inline-block;">
<canvas id="myChart" width="400" height="400"></canvas>
<div id="centerDiamond"><img id="brawlerImg" src="https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/elprimo.png" alt="Brawler"></div>
</div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  'https://ttkneykkrkbajymzsgcr.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0a25leWtrcmtiYWp5bXpzZ2NyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5OTAyMjIsImV4cCI6MjA3MTU2NjIyMn0.Zsqy_PZ6K-3iTjh7nkTyH-7M9gOnSFHt4f0p9y_WPiE'
);

const PAGE_ID = 'pagina1';

const refs = {
  inputs: {
    bpass: document.getElementById("bpass"),
    comunes: document.getElementById("comunes"),
    raras: document.getElementById("raras"),
    epicas: document.getElementById("epicas"),
    miticas: document.getElementById("miticas"),
    legendarias: document.getElementById("legendarias"),
    hipercarga: document.getElementById("hipercarga"),
    maxeados: document.getElementById("maxeados")
  },
  resultado: document.getElementById("resultado"),
  calcBtn: document.getElementById("calcBtn"),
  clearBtn: document.getElementById("clearBtn"),
  shareBtn: document.getElementById("shareBtn"),
  chartCanvas: document.getElementById("myChart"),
  centerDiamond: document.getElementById("centerDiamond"),
  brawlerImg: document.getElementById("brawlerImg"),
  metricCounters: {
    visitas: document.getElementById("visitas-counter"),
    likes: document.getElementById("likes-counter"),
    dislikes: document.getElementById("dislikes-counter")
  }
};

const VALORES = {
  "üéüÔ∏è Brawl Pass":10,
  "ü©µ Comunes":2,
  "üíö Raras":5,
  "üíú √âpicas":10,
  "‚ù§Ô∏è M√≠ticas":12,
  "üåü Legendarias":15,
  "‚ö° Hipercarga":20,
  "üî• Maxeados":50
};

let chart;
let brawlers = [
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/elprimo.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/colt.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/nita.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/edgar.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/spike.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/penny.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/darryl.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/rico.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/mortis.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/bea.png"
];
let currentBrawler = 0;

// Funciones de sonido y vibraci√≥n
function beep(freq){
  const ctx = new (AudioContext||webkitAudioContext)(),
        o = ctx.createOscillator(),
        g = ctx.createGain();
  o.type="square"; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
  g.gain.setValueAtTime(.15,ctx.currentTime);
  o.start(); o.stop(ctx.currentTime+.15);
}
function vibrar(ms=80){ if(navigator.vibrate) navigator.vibrate(ms); }

// Animar contadores
function animateCounter(el, value){
  let start = parseInt(el.innerText)||0;
  const end = Number(value)||0;
  const duration = 600;
  const t0 = performance.now();
  function step(t){
    const p = Math.min((t - t0)/duration,1);
    el.innerText = Math.floor(start + (end-start)*p);
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// Cargar m√©tricas desde Supabase
async function cargarMetricas(){
  const { data, error } = await supabase.from('metrics').select('visitas,likes,dislikes').eq('page_id', PAGE_ID).single();
  if(!error && data){
    animateCounter(refs.metricCounters.visitas,data.visitas);
    animateCounter(refs.metricCounters.likes,data.likes);
    animateCounter(refs.metricCounters.dislikes,data.dislikes);
  }
}

// Incrementar visitas
async function incrementarVisita(){
  await supabase.rpc('increment_visitas',{pid:PAGE_ID});
  await cargarMetricas();
}

// Votar like/dislike
async function votar(tipo){
  const prev = localStorage.getItem('vote');
  try{
    if(prev===tipo) return;
    if(!prev){
      if(tipo==='like') await supabase.rpc('increment_likes',{pid:PAGE_ID});
      else if(tipo==='dislike') await supabase.rpc('increment_dislikes',{pid:PAGE_ID});
    } else {
      if(prev==='like' && tipo==='dislike'){
        await supabase.rpc('decrement_likes',{pid:PAGE_ID});
        await supabase.rpc('increment_dislikes',{pid:PAGE_ID});
      } else if(prev==='dislike' && tipo==='like'){
        await supabase.rpc('decrement_dislikes',{pid:PAGE_ID});
        await supabase.rpc('increment_likes',{pid:PAGE_ID});
      }
    }
    localStorage.setItem('vote',tipo);
    animateFlash(tipo);
    await cargarMetricas();
  }catch(e){ console.error(e);}
}

// Flash efecto neon
function animateFlash(tipo){
  const el = tipo==='like'?refs.metricCounters.likes:tipo==='dislike'?refs.metricCounters.dislikes:refs.metricCounters.visitas;
  el.classList.add('flash');
  setTimeout(()=>el.classList.remove('flash'),200);
}
refs.metricCounters.likes.parentElement.addEventListener('click',()=>votar('like'));
refs.metricCounters.dislikes.parentElement.addEventListener('click',()=>votar('dislike'));

// Calcular
function calcular(){
  beep(600); vibrar(); refs.calcBtn.classList.add('flash'); setTimeout(()=>refs.calcBtn.classList.remove('flash'),200);

  const valoresCalc = {};
  let total = 0;
  for(const key in VALORES){
    const id = {
      "üéüÔ∏è Brawl Pass":"bpass","ü©µ Comunes":"comunes","üíö Raras":"raras","üíú √âpicas":"epicas","‚ù§Ô∏è M√≠ticas":"miticas","üåü Legendarias":"legendarias","‚ö° Hipercarga":"hipercarga","üî• Maxeados":"maxeados"
    }[key];
    const val = Number(refs.inputs[id].value)||0;
    valoresCalc[key] = val*VALORES[key];
    total += valoresCalc[key];
  }
  refs.resultado.innerText="Valor total: "+total+" ‚Ç¨";

  // Confeti
  confetti({particleCount:100,spread:70,origin:{y:0.6}});

  // Chart
  const data = {labels:Object.keys(valoresCalc),datasets:[{data:Object.values(valoresCalc),backgroundColor:["#00FFFF","#00FF00","#FF00FF","#FFFF00","#FF4500","#00CFFF","#FF69B4","#FF0000"],borderWidth:2}]};
  const config = {type:'doughnut',data:data,options:{cutout:"70%",plugins:{legend:{display:true,position:'bottom'}}}};
  if(chart) chart.destroy();
  chart = new Chart(refs.chartCanvas.getContext('2d'),config);

  refs.centerDiamond.style.display="block";
  refs.chartCanvas.scrollIntoView({behavior:'smooth',block:'center'});
}

// Limpiar
function limpiar(){
  beep(300); vibrar(); refs.clearBtn.classList.add('flash'); setTimeout(()=>refs.clearBtn.classList.remove('flash'),200);
  document.getElementById("calcForm").reset();
  refs.resultado.innerText="Valor total: 0 ‚Ç¨";
  if(chart) chart.destroy();
  refs.centerDiamond.style.display="none";
}

// Compartir
refs.shareBtn.addEventListener("click",async ()=>{
  beep(500); vibrar(); refs.shareBtn.classList.add('flash'); setTimeout(()=>refs.shareBtn.classList.remove('flash'),200);
  const url = window.location.href;
  const text = "Mira cu√°nto valen mis Brawlers en Brawl Stars!";
  if(navigator.share){ try{await navigator.share({title:"Calculadora Brawl Stars",text,url});}catch(err){console.log(err);} }
  else { alert("Tu navegador no soporta compartir nativo."); }
});

// Animaci√≥n Brawler central
setInterval(()=>{
  currentBrawler = (currentBrawler+1)%brawlers.length;
  refs.brawlerImg.src = brawlers[currentBrawler];
},3000);

// Eventos botones
refs.calcBtn.addEventListener("click",calcular);
refs.clearBtn.addEventListener("click",limpiar);

// Inicializaci√≥n
(async ()=>{
  await incrementarVisita();
  await cargarMetricas();
})();
</script>
</body>
</html>
