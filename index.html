window.addEventListener('click',(e)=>{ if(e.target===infoModal) infoModal.style.display='none'; });

// ===== FUNCIONES CALCULAR Y LIMPIAR =====
function calcular(){
  beep(600); vibrar();
  document.getElementById('calcBtn').classList.add('flash');
  setTimeout(()=>document.getElementById('calcBtn').classList.remove('flash'),200);

  const bpass = Number(document.getElementById("bpass").value)||0;
  const comunes = Number(document.getElementById("comunes").value)||0;
  const raras = Number(document.getElementById("raras").value)||0;
  const epicas = Number(document.getElementById("epicas").value)||0;
  const miticas = Number(document.getElementById("miticas").value)||0;
  const legendarias = Number(document.getElementById("legendarias").value)||0;
  const hipercarga = Number(document.getElementById("hipercarga").value)||0;
  const maxeados = Number(document.getElementById("maxeados").value)||0;

  const valores={
    "🎟️ Brawl Pass":bpass*10,
    "🩵 Comunes":comunes*2,
    "💚 Raras":raras*5,
    "💜 Épicas":epicas*10,
    "❤️ Míticas":miticas*12,
    "🌟 Legendarias":legendarias*15,
    "⚡ Hipercarga":hipercarga*20,
    "🔥 Maxeados":maxeados*50
  };

  const total = Object.values(valores).reduce((a,b)=>a+b,0);

  const resultadoEl = document.getElementById("resultado");
  let start = parseInt(resultadoEl.innerText.replace(/\D/g,'')) || 0;
  const end = total;
  const duration = 800;
  const t0 = performance.now();
  function step(t){
    const p = Math.min((t - t0)/duration,1);
    resultadoEl.innerText = "Valor total: "+Math.floor(start + (end-start)*p)+" €";
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  const data = {
    labels:Object.keys(valores),
    datasets:[{
      data:Object.values(valores),
      backgroundColor:["#00FFFF","#00FF00","#FF00FF","#FFFF00","#FF4500","#00CFFF","#FF69B4","#FF0000"],
      borderWidth:2
    }]
  };
  const config = { type:'doughnut', data:data, options:{ cutout:"70%", plugins:{legend:{display:true,position:'bottom'}} }};
  if(chart) chart.destroy();
  chart = new Chart(document.getElementById('myChart').getContext('2d'), config);

  confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
  document.getElementById('centerDiamond').style.display="block";
  document.getElementById('myChart').scrollIntoView({behavior:'smooth', block:'center'});

  // ===== RUETA BRAWLER =====
  girarBrawler();
}

function limpiar(){
  beep(300); vibrar();
  document.getElementById('clearBtn').classList.add('flash');
  setTimeout(()=>document.getElementById('clearBtn').classList.remove('flash'),200);
  document.getElementById("calcForm").reset();
  document.getElementById("resultado").innerText="Valor total: 0 €";
  if(chart) chart.destroy();
  document.getElementById("centerDiamond").style.display="none";
  window.scrollTo({top:0, behavior:'smooth'});
}

// ===== RUEDA ALEATORIA DE BRAWLERS =====
function girarBrawler(){
  const today = new Date();
  const seed = today.getFullYear()*10000 + (today.getMonth()+1)*100 + today.getDate();
  let steps = 20 + Math.floor(Math.random()*10);
  let index = seed % brawlers.length;
  let delay = 50;
  for(let i=0;i<steps;i++){
    setTimeout(()=>{
      index = (index+1)%brawlers.length;
      brawlerImg.src = brawlers[index];
    }, delay);
    delay += Math.floor(Math.random()*40)+30;
  }
}

// ===== EVENTOS =====
document.getElementById("calcBtn").addEventListener("click",calcular);
document.getElementById("clearBtn").addEventListener("click", limpiar);
document.getElementById("shareBtn").addEventListener("click", async ()=>{
  beep(500); vibrar(); document.getElementById('shareBtn').classList.add('flash');
  setTimeout(()=>document.getElementById('shareBtn').classList.remove('flash'),200);
  const url = window.location.href;
  const text = "Mira cuánto valen mis Brawlers en Brawl Stars!";
  if(navigator.share){ 
    try{await navigator.share({title:"Calculadora Brawl Stars",text,url});}
    catch(err){console.log(err);}
  } else { alert("Tu navegador no soporta compartir nativo."); }
});
document.getElementById('shareBtn').classList.add('pulse');

// ===== INICIALIZACION =====
(async ()=>{
  await incrementarVisita();
  await cargarMetricas();
})();
</script>
</body>
</html>
