<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calculadora Brawl Stars</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<style>
/* ==== CSS BASE ==== */
body { margin: 0; font-family: 'Bangers', cursive; background: url('Personajes-Brawl-Stars.webp') no-repeat center center fixed; background-size: cover; color: white; text-align: center; position: relative; }
body::after { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); z-index: 0; }
.container { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
h1 { font-size: 3rem; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: 'Bangers', cursive; color: #FFD700; text-shadow: -2px -2px 0 black, 2px -2px 0 black, -2px 2px 0 black, 2px 2px 0 black; }
h1 .diamond { font-family: 'Bangers', cursive; font-size: 3rem; color: #32CD32; text-shadow: -1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000,0 0 6px #32CD32,0 0 12px #00FF00,0 0 18px #00FF7F; animation: glow 1.5s infinite alternate; }
@keyframes glow { 0% { text-shadow: -1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000,0 0 4px #32CD32,0 0 8px #00FF00,0 0 12px #00FF7F; } 50% { text-shadow: -1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000,0 0 8px #32CD32,0 0 16px #00FF00,0 0 24px #00FF7F; } 100% { text-shadow: -1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000,0 0 4px #32CD32,0 0 8px #00FF00,0 0 12px #00FF7F; } }
form { background: rgba(0,0,0,0.5); border-radius: 60px; padding: 20px; max-width: 600px; width: 90%; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; position: relative; border: 2px solid #FFA500; box-shadow: 0 0 18px rgba(255,165,0,.7),0 0 36px rgba(255,165,0,.35); }
label { display:flex; justify-content:space-between; margin:8px 0; width:100%; }
input { width:100px; text-align:center; border:none; border-radius:8px; }
.buttons { display:flex; justify-content:center; gap:25px; margin-top:15px; }
button { padding:10px 20px; border:none; border-radius:12px; font-family:'Bangers'; font-size:1.5rem; color:white; cursor:pointer; transition: transform .08s ease; }
button:active { transform: scale(0.97); }
button.flash { box-shadow: 0 0 20px #fff,0 0 30px #fff,0 0 40px #fff; transition: box-shadow 0.2s ease; }
#calcBtn,#clearBtn{background: linear-gradient(90deg,#FFD700,#FFA500); color: black;}
#shareBtn{ background:linear-gradient(90deg,#00FFAA,#FF00FF); margin-top:20px; color:white; }
#shareBtn.pulse { animation: pulseBorder 1s infinite; }
@keyframes pulseBorder { 0% { box-shadow: 0 0 10px #FF00FF,0 0 20px #FF00FF; transform: scale(1); } 50% { box-shadow: 0 0 25px #FF00FF,0 0 35px #FF00FF; transform: scale(1.05); } 100% { box-shadow: 0 0 10px #FF00FF,0 0 20px #FF00FF; transform: scale(1); } }
#spinBtn{ margin-top:10px; padding:8px 16px; font-size:1.1rem; background: linear-gradient(90deg,#FFA500,#FF8C00); color:#000; box-shadow: 0 0 10px #FFA500,0 0 20px rgba(255,165,0,.5); border-radius: 12px; }
#infoBtn{ position:absolute; top:50%; left:50%; transform: translate(-50%, -50%); width:70px; height:70px; border-radius:50%; background: rgba(20,0,30,.25); border: 2px solid #B300FF; display:flex; align-items:center; justify-content:center; letter-spacing: 2px; color: #FFFFFF; font-size: 1.1rem; text-shadow: 0 0 6px #B300FF,0 0 12px #8000FF; box-shadow: 0 0 10px #B300FF,0 0 20px rgba(179,0,255,.35); cursor:pointer; z-index:2; animation: infoPulse 1.6s ease-in-out infinite; }
@keyframes infoPulse{ 0% { box-shadow:0 0 8px #B300FF,0 0 16px rgba(179,0,255,.25); } 50% { box-shadow:0 0 14px #B300FF,0 0 28px rgba(179,0,255,.45); } 100% { box-shadow:0 0 8px #B300FF,0 0 16px rgba(179,0,255,.25); } }
.metric-container { display: flex; justify-content: center; gap: 22px; margin-top: 18px; }
.metric { display: flex; flex-direction: column; align-items: center; gap: 6px; font-family:'Orbitron', sans-serif; font-size: 2rem; }
.metric .box { background: rgba(0,0,0,0.7); padding: 8px 18px; border-radius: 12px; min-width: 70px; text-align: center; font-weight: 700; user-select: none; transition: all 0.2s ease; cursor:pointer; }
.metric.visitas .box { border: 2px solid #00CFFF; color: #00CFFF; box-shadow:0 0 10px #00CFFF,0 0 20px #00CFFF;}
.metric.likes .box { border: 2px solid #39ff14; color: #39ff14; box-shadow:0 0 10px #39ff14,0 0 20px #39ff14;}
.metric.dislikes .box { border: 2px solid #FF073A; color: #FF073A; box-shadow:0 0 10px #FF073A,0 0 20px #FF073A;}
canvas{ margin-top:15px; max-width:400px; position:relative; }
#centerDiamond { position: absolute; top: 43%; left: 50%; transform: translate(-50%, -50%); display: block; }
#centerDiamond img { width: 210px; height: 210px; border-radius: 50%; object-fit: contain; background: rgba(0,0,0,0.3); transition: all 0.4s ease; }
#centerDiamond img.finalGlow { box-shadow: 0 0 20px #fff, 0 0 40px #fff, 0 0 60px #fff; }
#resultado { margin:10px 0; font-size:2rem; font-family:'Bangers'; color:#00FF00; text-shadow:0 0 8px #00FF00,0 0 15px #00FF00; }
#infoModal{ position: fixed; inset: 0; background: rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index: 9999; }
#infoModal .content{ background: #0f0b18; border: 2px solid #FFD700; box-shadow: 0 0 18px #FFD700,0 0 36px rgba(255,215,0,.4); border-radius: 16px; max-width: 560px; width: 90%; padding: 18px 18px 12px; text-align: left; font-family: 'Orbitron', sans-serif; color: #fff; }
#infoModal .content h3{ margin: 0 0 8px; color: #FFD700; font-family: 'Bangers'; font-size: 1.8rem; }
#infoModal .content p{ margin: 6px 0; line-height: 1.35; font-size: 1rem; }
#infoClose{ float:right; font-size: 1.5rem; color: #FF4D4D; cursor:pointer; margin-left: 8px; }
#infoClose:hover{ filter: brightness(1.2); }
.segmentGlowBlue { box-shadow:0 0 15px 4px #00CFFF; }
.segmentGlowRed { box-shadow:0 0 15px 4px #FF073A; }
.segmentGlowOrange { box-shadow:0 0 15px 4px #FFA500; }
.segmentGlowGreen { box-shadow:0 0 15px 4px #00FF00; }
.glow-blue { box-shadow: 0 0 25px #00f, 0 0 50px #00f, 0 0 75px #00f, 0 0 100px #00CFFF; animation: glow-blue 3s infinite alternate; }
.glow-red  { box-shadow: 0 0 20px #f00, 0 0 40px #f00, 0 0 60px #f00; animation: glow-red 3s infinite alternate; }
.glow-orange { box-shadow: 0 0 20px #f90, 0 0 40px #f90, 0 0 60px #f90; animation: glow-orange 3s infinite alternate; }
.glow-green { box-shadow: 0 0 20px #0f0, 0 0 40px #0f0, 0 0 60px #0f0; animation: glow-green 3s infinite alternate; }
@keyframes glow-blue { 0% { box-shadow: 0 0 10px #00f, 0 0 20px #00CFFF; } 50% { box-shadow: 0 0 40px #00f, 0 0 80px #00CFFF; } 100% { box-shadow: 0 0 10px #00f, 0 0 20px #00CFFF; } }
@keyframes glow-red { 0% { box-shadow: 0 0 10px #f00, 0 0 20px #f00; } 50% { box-shadow: 0 0 25px #f00, 0 0 45px #f00; } 100% { box-shadow: 0 0 10px #f00, 0 0 20px #f00; } }
@keyframes glow-orange { 0% { box-shadow: 0 0 10px #f90, 0 0 20px #f90; } 50% { box-shadow: 0 0 25px #f90, 0 0 45px #f90; } 100% { box-shadow: 0 0 10px #f90, 0 0 20px #f90; } }
@keyframes glow-green { 0% { box-shadow: 0 0 10px #0f0, 0 0 20px #0f0; } 50% { box-shadow: 0 0 25px #0f0, 0 0 45px #0f0; } 100% { box-shadow: 0 0 10px #0f0, 0 0 20px #0f0; } }
/* ===== BURBUJA DE MISI√ìN ===== */
.mission-bubble {
  position: absolute;
  max-width: 220px;
  padding: 10px 15px;
  background: rgba(0, 0, 0, 0.85);
  color: #ffffff;
  font-weight: bold;
  font-size: 14px;
  text-align: center;
  border-radius: 12px;
  border: 4px solid #ffffff;
  z-index: 9999;
  pointer-events: none;
  opacity: 1;
  transition: opacity 1s, transform 0.3s;
  transform: translate(-50%, -120%); /* centra la burbuja sobre el elemento */
}

.mission-bubble.fade-out {
  opacity: 0;
  transform: translate(-50%, -150%);
}
</style>
</head>
<body>
<div class="container">
  <h1><span class="diamond">‚≠ê</span> Calculadora Brawl Stars <span class="diamond">‚≠ê</span></h1>
  <form id="calcForm">
    <label>üéüÔ∏è Brawl Pass: <input type="number" id="bpass" value="0"></label>
    <label>ü©µ Comunes: <input type="number" id="comunes" value="0"></label>
    <label>üíö Raras: <input type="number" id="raras" value="0"></label>
    <label>üíú √âpicas: <input type="number" id="epicas" value="0"></label>
    <label>‚ù§Ô∏è M√≠ticas: <input type="number" id="miticas" value="0"></label>
    <label>üåü Legendarias: <input type="number" id="legendarias" value="0"></label>
    <label>‚ö° Hipercarga: <input type="number" id="hipercarga" value="0"></label>
    <label>üî• Maxeados: <input type="number" id="maxeados" value="0"></label>
    <button type="button" id="infoBtn">INFO</button>
  </form>

  <!-- Botones calcular y limpiar arriba -->
  <div class="buttons">
    <button id="calcBtn">Calcular</button>
    <button id="clearBtn">Limpiar</button>
  </div>

  <!-- Bot√≥n compartir -->
  <button id="shareBtn">üì§ Compartir</button>

  <!-- Valor total entre compartir y girar brawler -->
  <div id="resultado">Valor total: 0 ü™ô</div>

  <!-- Bot√≥n girar brawler -->
  <button id="spinBtn">üé≤ Girar Brawler</button>

  <!-- M√©tricas -->
  <div class="metric-container">
    <div class="metric visitas"><span class="icon">üëÄ</span><div class="box" id="visitas-counter">0</div></div>
    <div class="metric likes"><span class="icon">üëç</span><div class="box" id="likes-counter">0</div></div>
    <div class="metric dislikes"><span class="icon">üëé</span><div class="box" id="dislikes-counter">0</div></div>
  </div>

  <!-- Gr√°fico y brawler -->
  <div style="position:relative; display:inline-block;">
    <canvas id="myChart" width="400" height="400"></canvas>
    <div id="centerDiamond">
      <img id="brawlerImg" src="" alt="Brawler">
    </div>
  </div>
  <div id="infoModal">
    <div class="content">
      <span id="infoClose">√ó</span>
      <h3>Informaci√≥n</h3>
      <p>Hola BRAWLER, esta es la calculadora que siempre has so√±ado probar.</p>
      <p>- üéüÔ∏è Brawl Pass: Ingresa el total aprox. de los BrawlPass que has utilizado.</p>
      <p>- ü©µüíöüíú‚ù§Ô∏èüåü Skins: Ingresa la cantidad de skins ( en la tienda del juego, cada modalidad tiene su total en la parte superior derecha‚ÜóÔ∏è ).</p>
      <p>- ‚ö°üî• Brawlers maxeados: Sumando los Brawlers maxeados con sus hipercargas, sabr√°s el valor aproximado de tu cuenta.</p>
      <p>- üé≤ Interactua: ¬°Gira y juega! Este es tu Brawler del dia,aparecera dentro de un glowüü¢! vuelve ma√±ana sera otroüéØ.</p>
      <p>¬°A qu√© esperas! Haz tu c√°lculo, deja tu likeüëç comparteüì§ vuelve al juego y dale ca√±aüèÜ.</p>
    </div>
  </div>
     <script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

document.addEventListener('DOMContentLoaded', () => {

  /* ===== CONFIG & CLIENT ===== */
  const supabase = createClient(
    'https://ttkneykkrkbajymzsgcr.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0a25leWtrcmtiYWp5bXpzZ2NyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5OTAyMjIsImV4cCI6MjA3MTU2NjIyMn0.Zsqy_PZ6K-3iTjh7nkTyH-7M9gOnSFHt4f0p9y_WPiE'
  );
  const PAGE_ID = 'pagina1';

  /* ===== ELEMENTOS ===== */
  const calcBtn = document.getElementById('calcBtn');
  const clearBtn = document.getElementById('clearBtn');
  const shareBtn = document.getElementById('shareBtn');
  const spinBtn = document.getElementById('spinBtn');
  const infoBtn = document.getElementById('infoBtn');
  const infoModal = document.getElementById('infoModal');
  const infoClose = document.getElementById('infoClose');
  const brawlerImg = document.getElementById('brawlerImg');
  const visitasCounter = document.getElementById('visitas-counter');
  const likesCounter = document.getElementById('likes-counter');
  const dislikesCounter = document.getElementById('dislikes-counter');

  /* ===== CONSTANTES ===== */
  const allBrawlers = ["elprimo","colt","nita","edgar","spike","penny","darryl","rico","mortis","bea","8-bit","alli","amber","angelo","ash","barley","belle","berry","bibi","bo","bonnie","brock","bull","buster","buzz","byron","carl","charly","chester","chuck","clancy","colette","cordelius","crow","doug","draco","dynamike","eve","fang","finx","frank","gale","genio","gray","griff","grom","hank","gus","jacky","jae-yong","janet","jessie","max","meeple","meg","melodie","mico","moe","nani","otis","ollie","pam","pearl","piper","poco","r-t","rosa","ruffs","sam","sandy","shade","shelly","sprout","squeak","stu","surge","tick","trunk","willow"];
  const baseURL = "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/";
  const MISSIONS = [
    "Sube 10 copas con {brawler}",
    "Gana 3 partidas con {brawler}",
    "Haz 5 kills con {brawler}",
    "Sobrevive 3 partidas con {brawler}",
    "Juega competici√≥n con {brawler}",
    "Consigue ser top 1 con {brawler}",
    "Participa en 2 partidas de supervivencia con {brawler}",
    "Juega en d√∫o con {brawler}",
    "Usa 3 veces la s√∫per de {brawler}",
    "Haz 20000 de da√±o con {brawler}",
    "Defiende la base con {brawler}",
    "Gana una partida sin morir con {brawler}",
    "Juega 2 partidas en modo asedio con {brawler}",
    "Haz 1000 de curaci√≥n con {brawler}"
  ];

  /* ===== VARIABLES ===== */
  let chart = null;
  let brawlerCache = {};
  let activeBrawlers = [];
  let activePrepared = false;
  let _currentMissionEl = null;
  let _missionTimeout = null;

  /* ===== UTILIDADES ===== */
  function beep(freq){ const ctx = new (AudioContext||webkitAudioContext)(), o = ctx.createOscillator(), g = ctx.createGain(); o.type="square"; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(.15,ctx.currentTime); o.start(); o.stop(ctx.currentTime+.15); }
  function vibrar(ms=80){ if(navigator.vibrate) navigator.vibrate(ms); }
  function animateCounter(id,value){ const el = document.getElementById(id); let start=parseInt(el.innerText)||0; const end=Number(value)||0; const duration=800; const t0=performance.now(); function step(t){ const p=Math.min((t-t0)/duration,1); el.innerText=Math.floor(start+(end-start)*p); if(p<1) requestAnimationFrame(step); } requestAnimationFrame(step); }
  function pickRandomUnique(arr,count){ const copy=[...arr]; for(let i=copy.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [copy[i],copy[j]]=[copy[j],copy[i]]; } return copy.slice(0,Math.min(count,copy.length)); }
  function getLoadedImagesFromList(list){ return list.map(n=>brawlerCache[n]).filter(i=>i && i.complete && i.naturalWidth>0); }
  function safeSetBrawler(name,fallbackClass="finalGlow"){ const img=brawlerCache[name]; const loadedActive=getLoadedImagesFromList(activeBrawlers); const loadedAny=Object.values(brawlerCache).filter(i=>i && i.complete && i.naturalWidth>0); if(img && img.complete && img.naturalWidth>0){ brawlerImg.src=img.src; } else if(loadedActive.length>0){ const choice=loadedActive[Math.floor(Math.random()*loadedActive.length)]; brawlerImg.src=choice.src; } else if(loadedAny.length>0){ const choice=loadedAny[Math.floor(Math.random()*loadedAny.length)]; brawlerImg.src=choice.src; } else { brawlerImg.src="https://via.placeholder.com/210x210?text=Brawler"; } brawlerImg.className=fallbackClass; }

  /* ===== METRICAS ===== */
  async function cargarMetricas(){ const { data, error }=await supabase.from('metrics').select('visitas,likes,dislikes').eq('page_id',PAGE_ID).single(); if(!error && data){ animateCounter('visitas-counter',data.visitas); animateCounter('likes-counter',data.likes); animateCounter('dislikes-counter',data.dislikes); } }
  async function incrementarVisita(){ try{ await supabase.rpc('increment_visitas',{pid:PAGE_ID}); await cargarMetricas(); } catch(e){ console.error(e); } }

  /* ===== DAILY / MISION DIARIA ===== */
  function getOrCreateDailyName(){ const today=new Date().toISOString().slice(0,10); const saved=JSON.parse(localStorage.getItem('dailyBrawler')||'{}'); if(saved.date===today && saved.name) return saved.name; const idx=Math.floor(Math.random()*allBrawlers.length); const name=allBrawlers[idx]; localStorage.setItem('dailyBrawler',JSON.stringify({date:today,name})); return name; }
  function cyrb128(str){ let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762; for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);h1=h2^Math.imul(h1^k,597399067);h2=h3^Math.imul(h2^k,2869860233);h3=h4^Math.imul(h3^k,951274213);h4=h1^Math.imul(h4^k,2716044179);} return [(h1>>>0),(h2>>>0),(h3>>>0),(h4>>>0)]; }
  function mulberry32(a){ return function(){a|=0;a=a+0x6D2B79F5|0; let t=Math.imul(a^a>>>15,1|a); t=t+Math.imul(t^t>>>7,61|t)^t; return ((t^t>>>14)>>>0)/4294967296; }; }
  function seededShuffle(arr,seedStr){ const seedArr=cyrb128(seedStr); let seed=(seedArr[0]^seedArr[1]^seedArr[2]^seedArr[3])>>>0; const rnd=mulberry32(seed); const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function getMissionsForToday(numSegments=8){ const daily=getOrCreateDailyName(); const today=new Date().toISOString().slice(0,10); const seed=`${today}-${daily}`; const shuffled=seededShuffle(MISSIONS.slice(),seed); return shuffled.slice(0,Math.min(numSegments,shuffled.length)); }
  function showMissionBubbleOnCanvas(text, borderColor = '#FFFFFF', x = null, y = null) {
  const canvas = document.getElementById('myChart');
  if (!canvas) return;

  // eliminar burbuja anterior
  if (_currentMissionEl) {
    _currentMissionEl.remove();
    _currentMissionEl = null;
    if (_missionTimeout) { clearTimeout(_missionTimeout); _missionTimeout = null; }
  }

  // crear burbuja
  const el = document.createElement('div');
  el.className = 'mission-bubble';
  el.style.border = `4px solid ${borderColor}`;
  el.innerText = text;
  el.style.position = 'absolute';
  el.style.zIndex = 9999;
  el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  el.style.opacity = 1;

  // aseguramos que el contenedor del canvas sea relativo
  const parent = canvas.parentElement;
  parent.style.position = 'relative';
  parent.appendChild(el);

  // calcular posici√≥n relativa al canvas
  if (x === null || y === null) {
    const rect = canvas.getBoundingClientRect();
    x = rect.width / 2;  // centro por defecto
    y = rect.height / 2;
  }

  el.style.left = `${x}px`;
  el.style.top = `${y}px`;

  void el.offsetWidth; // forzar render

  // desaparecer despu√©s de 7s
  _missionTimeout = setTimeout(() => {
    el.style.opacity = 0;
    el.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      if (el.parentNode) el.parentNode.removeChild(el);
      if (_currentMissionEl === el) _currentMissionEl = null;
    }, 1000);
  }, 7000);

  _currentMissionEl = el;
  }
                                                                                                                                                                                                                              
  /* ===== PRECARGA BRAWLERS ===== */
  allBrawlers.forEach(name=>{ const img=new Image(); img.src=baseURL+name+".png"; brawlerCache[name]=img; });

  async function prepareActiveBrawlers(count=20,timeoutMs=8000){
    return new Promise(resolve=>{
      const selected=pickRandomUnique(allBrawlers,count);
      activeBrawlers=selected.slice();
      const promises=activeBrawlers.map(name=>new Promise(res=>{
        const img=brawlerCache[name]; if(!img){ const newImg=new Image(); newImg.src=baseURL+name+".png"; brawlerCache[name]=newImg; newImg.onload=()=>res({name,ok:true}); newImg.onerror=()=>res({name,ok:false}); } else { if(img.complete && img.naturalWidth>0) return res({name,ok:true}); const t=setTimeout(()=>res({name,ok:false}),timeoutMs); img.onload=()=>{ clearTimeout(t); res({name,ok:true}); }; img.onerror=()=>{ clearTimeout(t); res({name,ok:false}); }; } }));
      Promise.all(promises).then(results=>{ const ok=results.filter(r=>r.ok).map(r=>r.name); if(ok.length>0) activeBrawlers=ok; else{ const loadedAny=Object.keys(brawlerCache).filter(n=>{ const im=brawlerCache[n]; return im && im.complete && im.naturalWidth>0; }); if(loadedAny.length>0) activeBrawlers=pickRandomUnique(loadedAny,Math.min(count,loadedAny.length)); else activeBrawlers=pickRandomUnique(allBrawlers,Math.min(count,allBrawlers.length)); } activePrepared=true; if(spinBtn) spinBtn.disabled=false; resolve(activeBrawlers); });
    });
  }
  /* ===== CALCULAR ===== */
function calcular(){
  beep(600); vibrar();
  calcBtn.classList.add('flash');
  setTimeout(()=>calcBtn.classList.remove('flash'),200);

  const bpass = Number(document.getElementById("bpass").value)||0;
  const comunes = Number(document.getElementById("comunes").value)||0;
  const raras = Number(document.getElementById("raras").value)||0;
  const epicas = Number(document.getElementById("epicas").value)||0;
  const miticas = Number(document.getElementById("miticas").value)||0;
  const legendarias = Number(document.getElementById("legendarias").value)||0;
  const hipercarga = Number(document.getElementById("hipercarga").value)||0;
  const maxeados = Number(document.getElementById("maxeados").value)||0;

  const valores={
    "üéüÔ∏è Brawl Pass":bpass*10,
    "ü©µ Comunes":comunes*2,
    "üíö Raras":raras*5,
    "üíú √âpicas":epicas*10,
    "‚ù§Ô∏è M√≠ticas":miticas*12,
    "üåü Legendarias":legendarias*15,
    "‚ö° Hipercarga":hipercarga*20,
    "üî• Maxeados":maxeados*50
  };
  const total = Object.values(valores).reduce((a,b)=>a+b,0);

  const resultadoEl = document.getElementById("resultado");
  let start = parseInt(resultadoEl.innerText.replace(/\D/g,''))||0;
  const end = total;
  const duration = 800;
  const t0 = performance.now();
  function step(t){
    const p = Math.min((t-t0)/duration,1);
    resultadoEl.innerText = "Valor total: "+Math.floor(start + (end-start)*p)+" ü™ô";
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  const data={labels:Object.keys(valores),datasets:[{data:Object.values(valores),backgroundColor:["#00FFFF","#00FF00","#FF00FF","#FFFF00","#FF4500","#00CFFF","#FF69B4","#FF0000"],borderWidth:2}]};
  const config={type:'doughnut',data:data,options:{cutout:"70%",plugins:{legend:{display:true,position:'bottom'}}}};
  if(chart) chart.destroy();
  chart = new Chart(document.getElementById('myChart').getContext('2d'), config);

  confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
  document.getElementById('centerDiamond').style.display="block";

  // ===== CLICK EN EL CHART PARA MOSTRAR MISI√ìN =====
  attachChartClickListener();

  // ===== SCROLL SUAVE HACIA EL CHART =====
  document.getElementById('myChart').scrollIntoView({behavior:'smooth', block:'center'});
}

/* ===== ATTACH CLICK LISTENER DE MANERA SEGURA ===== */
chartCanvas.onclick = (e) => {
  const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
  if (!points.length) return;

  const dataIndex = points[0].index;
  const borderColor = chart.data.datasets[0].backgroundColor[dataIndex];

  const dailyName = getOrCreateDailyName();
  const missions = getMissionsForToday();
  const missionText = missions[dataIndex % missions.length].replace("{brawler}", dailyName);

  const meta = chart.getDatasetMeta(0);
  const arc = meta.data[dataIndex];
  const angle = (arc.startAngle + arc.endAngle)/2 - Math.PI/2;
  const radius = arc.outerRadius + 20;
  let x = arc.x + radius * Math.cos(angle);
  let y = arc.y + radius * Math.sin(angle);

  // ajustar posici√≥n para que la burbuja siempre quede fuera del c√≠rculo
  const centerX = arc.x;
  const centerY = arc.y;

  if (x < centerX) x -= 100;  // mover a la izquierda si estamos a la izquierda
  else x += 10;                // mover a la derecha si estamos a la derecha

  if (y < centerY) y -= 10;    // mover arriba si estamos arriba
  else y += 10;                // mover abajo si estamos abajo

  showMissionBubbleOnCanvas(`üìå ${missionText}`, borderColor, x, y);
  }
};

  /* ===== LIMPIAR ===== */
  function limpiar() {
    beep(300);
    vibrar();
    clearBtn.classList.add('flash');
    setTimeout(() => clearBtn.classList.remove('flash'), 200);

    document.getElementById("calcForm").reset();
    document.getElementById("resultado").innerText = "Valor total: 0 ü™ô";
    if (chart) chart.destroy();

    // Mostrar un brawler inicial distinto al daily
    const dailyName = getOrCreateDailyName();
    let candidates = (activePrepared && activeBrawlers.length > 0) ? activeBrawlers.slice() : allBrawlers.slice();
    candidates = candidates.filter(n => n !== dailyName);
    const start = candidates.length ? candidates[Math.floor(Math.random() * candidates.length)] : dailyName;
    safeSetBrawler(start);
    brawlerImg.className = "finalGlow";

    document.getElementById('calcForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  /* ===== SHARE ===== */
  async function share() {
    beep(500);
    vibrar();
    shareBtn.classList.add('flash');
    setTimeout(() => shareBtn.classList.remove('flash'), 200);

    const url = window.location.href;
    const text = "Mira cu√°nto valen mis Brawlers en Brawl Stars!";
    if (navigator.share) {
      try { await navigator.share({ title: "Calculadora Brawl Stars", text, url }); }
      catch (err) { console.log(err); }
    } else {
      try { await navigator.clipboard.writeText(url); alert("Enlace copiado al portapapeles ‚úÖ"); }
      catch (e) { prompt("Copia este enlace:", url); }
    }
  }

  /* ===== VOTO ===== */
  function getUserVote() { return JSON.parse(localStorage.getItem(`${PAGE_ID}-vote`) || '{}'); }
  function setUserVote(vote) { localStorage.setItem(`${PAGE_ID}-vote`, JSON.stringify(vote)); }

  likesCounter.addEventListener('click', async () => {
    beep(400);
    vibrar();
    let vote = getUserVote();
    if (vote.type === 'like') { vote = {}; await supabase.rpc('decrement_likes', { pid: PAGE_ID }); }
    else { if (vote.type === 'dislike') await supabase.rpc('decrement_dislikes', { pid: PAGE_ID }); vote = { type: 'like' }; await supabase.rpc('increment_likes', { pid: PAGE_ID }); }
    setUserVote(vote);
    cargarMetricas();
  });

  dislikesCounter.addEventListener('click', async () => {
    beep(300);
    vibrar();
    let vote = getUserVote();
    if (vote.type === 'dislike') { vote = {}; await supabase.rpc('decrement_dislikes', { pid: PAGE_ID }); }
    else { if (vote.type === 'like') await supabase.rpc('decrement_likes', { pid: PAGE_ID }); vote = { type: 'dislike' }; await supabase.rpc('increment_dislikes', { pid: PAGE_ID }); }
    setUserVote(vote);
    cargarMetricas();
  });

  /* ===== RULETA (termina en el daily, no empieza con √©l) ===== */
  function spinRouletteSmooth() {
    let brawlersList = (activePrepared && activeBrawlers.length > 0) ? activeBrawlers.slice() : allBrawlers.slice();
    const dailyName = getOrCreateDailyName();

    // aseguramos que el daily est√© presente
    if (!brawlersList.includes(dailyName)) {
      const replaceIdx = Math.floor(Math.random() * brawlersList.length);
      brawlersList[replaceIdx] = dailyName;
    }

    const numBrawlers = brawlersList.length;
    const finalIndex = brawlersList.indexOf(dailyName);
    const totalDuration = 10000;
    const slowDuration = 2000;
    const fastDuration = totalDuration - slowDuration;
    const finalSlowSteps = Math.min(6, numBrawlers);
    const indices = Array.from({ length: numBrawlers }, (_, i) => i);
    const shuffledFast = [...indices].sort(() => Math.random() - 0.5);

    if (brawlersList[shuffledFast[0]] === dailyName) {
      const swapIdx = shuffledFast.findIndex(i => brawlersList[i] !== dailyName);
      if (swapIdx > 0) [shuffledFast[0], shuffledFast[swapIdx]] = [shuffledFast[swapIdx], shuffledFast[0]];
    }

    const temp = indices.filter(i => i !== finalIndex);
    const slowSequence = [];
    for (let i = 0; i < finalSlowSteps - 1; i++) {
      const idx = Math.floor(Math.random() * temp.length);
      slowSequence.push(temp[idx]);
      temp.splice(idx, 1);
    }
    slowSequence.push(finalIndex);

    const glowClasses = ["glow-blue", "glow-red", "glow-orange", "glow-green"];
    const startTime = performance.now();
    let fastStep = 0, slowStep = 0, phase = "fast", lastTime = performance.now();
    const fastInterval = 60;

    function showImageSafe(name, glowClass) {
      const img = brawlerCache[name];
      const loadedActive = getLoadedImagesFromList(brawlersList);
      const loadedAny = Object.values(brawlerCache).filter(i => i && i.complete && i.naturalWidth > 0);
      if (img && img.complete && img.naturalWidth > 0) brawlerImg.src = img.src;
      else if (loadedActive.length > 0) brawlerImg.src = loadedActive[Math.floor(Math.random() * loadedActive.length)].src;
      else if (loadedAny.length > 0) brawlerImg.src = loadedAny[Math.floor(Math.random() * loadedAny.length)].src;
      else brawlerImg.src = "https://via.placeholder.com/210x210?text=Brawler";
      brawlerImg.className = glowClass;
    }

    function animate(currentTime) {
      const elapsed = currentTime - startTime;

      if (phase === "fast") {
        if (elapsed >= fastDuration) { phase = "slow"; lastTime = currentTime; }
        else if (currentTime - lastTime >= fastInterval) {
          const name = brawlersList[shuffledFast[fastStep % shuffledFast.length]];
          const glow = glowClasses[fastStep % glowClasses.length];
          showImageSafe(name, glow);
          fastStep++; lastTime = currentTime;
        }
      }

      if (phase === "slow") {
        const slowElapsed = elapsed - fastDuration;
        const stepDuration = slowDuration / finalSlowSteps;
        if (slowElapsed >= stepDuration * slowStep) {
          if (slowStep < finalSlowSteps) {
            const idx = slowSequence[slowStep];
            const name = brawlersList[idx];
            const glow = slowStep < finalSlowSteps - 1 ? glowClasses[(fastStep + slowStep) % glowClasses.length] : "glow-green finalGlow";
            showImageSafe(name, glow);
            slowStep++;
          }
          if (slowStep >= finalSlowSteps) {
            safeSetBrawler(dailyName, "glow-green finalGlow");
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.5 } });
            const missionText = getMissionsForToday()[0].replace("{brawler}", dailyName);
            showMissionBubble(`üìå ${missionText}`, "#00FF00");
            return;
          }
        }
      }
      requestAnimationFrame(animate);
    }

    requestAnimationFrame(animate);
  }

  /* ===== EVENTOS BOTONES ===== */
  calcBtn.addEventListener('click', () => { beep(520); vibrar(80); calcular(); });
  clearBtn.addEventListener('click', limpiar);
  shareBtn.addEventListener('click', share);
  spinBtn.addEventListener('click', () => { beep(520); vibrar(80); if (!spinBtn.disabled) spinRouletteSmooth(); });
  infoBtn.addEventListener('click', () => infoModal.style.display = 'flex');
  infoClose.addEventListener('click', () => infoModal.style.display = 'none');
  infoModal.addEventListener('click', e => { if (e.target === infoModal) infoModal.style.display = 'none'; });
  shareBtn.classList.add('pulse');

  /* ===== INICIALIZACI√ìN ===== */
  if(spinBtn) spinBtn.disabled = true;
  prepareActiveBrawlers(20).then(() => {
    // Obtener daily estable
    const dailyName = getOrCreateDailyName();

    // Si el daily no est√° en activeBrawlers, lo insertamos para garantizar su presencia y precarga
    if(!activeBrawlers.includes(dailyName)){
      const idx = Math.floor(Math.random()*activeBrawlers.length);
      activeBrawlers[idx] = dailyName;
      // forzamos inicio de carga si hac√≠a falta
      if(!brawlerCache[dailyName]){
        const n = new Image();
        n.src = baseURL + dailyName + ".png";
        brawlerCache[dailyName] = n;
      } else {
        brawlerCache[dailyName].src = baseURL + dailyName + ".png";
      }
    }

    // Mostramos un Brawler inicial que NO sea el daily (evita sensaci√≥n de empezar y terminar igual)
    const nonDaily = activeBrawlers.filter(n => n !== dailyName);
    const startName = nonDaily.length ? nonDaily[Math.floor(Math.random()*nonDaily.length)] : dailyName;
    safeSetBrawler(startName);

    if(spinBtn) spinBtn.disabled = false;
  }).catch(e=>{
    console.warn("prepareActiveBrawlers fallo: ", e);
    const dailyName = getOrCreateDailyName();
    safeSetBrawler(dailyName);
    if(spinBtn) spinBtn.disabled = false;
  });

  // m√©tricas en paralelo
  cargarMetricas();
  incrementarVisita();
});
</script>
  <!-- Script TikTok Browser: al final del body -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  function isTikTokBrowser() {
    const ua = navigator.userAgent || "";
    return /tiktok/i.test(ua) || /musical_ly/i.test(ua);
  }

  function getMobileOS() {
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    if (/android/i.test(ua)) return "Android";
    if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return "iOS";
    return "unknown";
  }

  if (isTikTokBrowser()) {
    const os = getMobileOS();
    let instructions = "abre este enlace en tu navegador para disfrutar de todas las funciones";
    if (os === "iOS") instructions = "pulsa el bot√≥n de compartir y selecciona 'Abrir en Safari'";
    if (os === "Android") instructions = "pulsa el bot√≥n de compartir y selecciona 'Abrir en Chrome u otro navegador'";

    // Overlay semitransparente
    const overlay = document.createElement('div');
    overlay.id = 'tiktokOverlay';
    overlay.style.cssText = `
      position:fixed; inset:0; background:rgba(255,255,255,0.85);
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      z-index:99998; font-family:'Bangers', cursive; color:#333; text-align:center; padding:20px;
    `;
    overlay.innerHTML = `
      <div style="max-width:320px;">
        <h2 style="font-size:1.8rem; margin-bottom:10px; color:#FFD700; text-shadow:1px 1px 2px #000;">üëã Hola Brawler</h2>
        <p style="font-size:1rem; color:#000; margin-bottom:15px;">
          TikTok Browser no permite disfrutar de todas las funciones de la calculadora.<br>
          Para usarla al 100%, ${instructions}.
        </p>
      </div>
    `;
    document.body.appendChild(overlay);

    // Banner superior
    const banner = document.createElement('div');
    banner.id = 'tiktokBanner';
    banner.style.cssText = `
      position:fixed; top:-120px; left:50%; transform:translateX(-50%);
      background:linear-gradient(90deg,#FFD700,#FFA500); color:#000; padding:12px 20px;
      border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); font-family:'Bangers', cursive;
      font-size:1rem; text-align:center; z-index:99999; display:flex; flex-direction:column;
      align-items:center; gap:8px; transition:top 0.6s ease;
    `;
    banner.innerHTML = `
      <div>üëÜ Para disfrutar de la una  mejor experiencia,accede a la calculadora desde tu navegadorüåê pulsando los ‚ö™‚ö™‚ö™ ‚ÜóÔ∏è TIKTOK bloquea algunas funciones,como la del brawler del dia</div>
      <div style="display:flex; gap:10px; margin-top:4px;">
        <a href="https://brawl-calculadora.vercel.app" target="_self" style="
          padding:6px 12px; font-family:'Bangers', cursive; font-size:0.95rem;
          border:none; border-radius:8px; cursor:pointer; background:#fff; color:#FFA500;
          text-decoration:none; display:inline-block; box-shadow:0 2px 6px rgba(0,0,0,0.2);">üåê Abrir en navegador</a>
        <button id="closeBannerBtn" style="
          padding:6px 12px; font-family:'Bangers', cursive; font-size:0.95rem;
          border:none; border-radius:8px; cursor:pointer; background:rgba(0,0,0,0.1); color:#000;">‚ùå Continuar aqu√≠</button>
      </div>
      <p style="font-size:0.85rem; margin-top:6px; color:#555;">No se guarda ning√∫n dato de tu dispositivo.</p>
    `;
    document.body.appendChild(banner);

    // Animaci√≥n entrada banner
    requestAnimationFrame(() => { banner.style.top = '20px'; });

    // Cerrar todo si pulsa "Continuar aqu√≠"
    document.getElementById('closeBannerBtn').addEventListener('click', () => {
      banner.style.top = '-120px';
      overlay.remove();
      setTimeout(() => banner.remove(), 500);
    });
  }
});
</script>
  </body>
</html>
