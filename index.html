<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calculadora Brawl Stars</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<style>
body { margin: 0; font-family: 'Bangers', cursive; background: url('Personajes-Brawl-Stars.webp') no-repeat center center fixed; background-size: cover; color: white; text-align: center; position: relative; }
body::after { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); z-index: 0; }
.container { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
h1 { font-size: 3rem; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: 'Bangers', cursive; color: #FFD700; text-shadow: -2px -2px 0 black, 2px -2px 0 black, -2px 2px 0 black, 2px 2px 0 black; }
h1 .diamond { font-family: 'Bangers', cursive; font-size: 3rem; color: #32CD32; text-shadow: -1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000,0 0 6px #32CD32,0 0 12px #00FF00,0 0 18px #00FF7F; animation: glow 1.5s infinite alternate; }
@keyframes glow { 0% { text-shadow: -1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000,0 0 4px #32CD32,0 0 8px #00FF00,0 0 12px #00FF7F; } 50% { text-shadow: -1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000,0 0 8px #32CD32,0 0 16px #00FF00,0 0 24px #00FF7F; } 100% { text-shadow: -1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000,0 0 4px #32CD32,0 0 8px #00FF00,0 0 12px #00FF7F; } }
/* FORMULARIO */
form { background: rgba(0,0,0,0.5); border-radius: 60px; padding: 20px; max-width: 600px; width: 90%; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; position: relative; border: 2px solid #FFA500; box-shadow: 0 0 18px rgba(255,165,0,.7),0 0 36px rgba(255,165,0,.35); }
label { display:flex; justify-content:space-between; margin:8px 0; width:100%; }
input { width:100px; text-align:center; border:none; border-radius:8px; }
.buttons { display:flex; justify-content:center; gap:25px; margin-top:15px; }
button { padding:10px 20px; border:none; border-radius:12px; font-family:'Bangers'; font-size:1.5rem; color:white; cursor:pointer; transition: transform .08s ease; }
button:active { transform: scale(0.97); }
#calcBtn {background: linear-gradient(90deg,#FFD700,#FFA500); color: black;}
#clearBtn {background: linear-gradient(90deg,#FFD700,#FFA500); color: black;}
#shareBtn{ background:linear-gradient(90deg,#00FFAA,#FF00FF); margin-top:20px; color:white; }
#spinBtn{ margin-top:10px; padding:8px 16px; font-size:1.1rem; background: linear-gradient(90deg,#FFA500,#FF8C00); color:#000; box-shadow: 0 0 10px #FFA500,0 0 20px rgba(255,165,0,.5); border-radius: 12px; }
#resultado { margin:10px 0; font-size:2rem; font-family:'Bangers'; color:#00FF00; text-shadow:0 0 8px #00FF00,0 0 15px #00FF00; }
#centerDiamond { position: absolute; top: 43%; left: 50%; transform: translate(-50%, -50%); display: block; }
#centerDiamond img { width: 210px; height: 210px; border-radius: 50%; object-fit: contain; background: rgba(0,0,0,0.3); transition: all 0.4s ease; }
/* MODAL */
#infoModal{ position: fixed; inset: 0; background: rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index: 9999; }
#infoModal .content{ background: #0f0b18; border: 2px solid #FFD700; box-shadow: 0 0 18px #FFD700,0 0 36px rgba(255,215,0,.4); border-radius: 16px; max-width: 560px; width: 90%; padding: 18px 18px 12px; text-align: left; font-family: 'Orbitron', sans-serif; color: #fff; }
#infoModal .content h3{ margin: 0 0 8px; color: #FFD700; font-family: 'Bangers'; font-size: 1.8rem; }
#infoModal .content p{ margin: 6px 0; line-height: 1.35; font-size: 1rem; }
#infoClose{ float:right; font-size: 1.5rem; color: #FF4D4D; cursor:pointer; margin-left: 8px; }
#infoClose:hover{ filter: brightness(1.2); }
/* Glow ruleta */
.glow-blue { box-shadow:0 0 25px #00f,0 0 50px #00f,0 0 75px #00f,0 0 100px #00CFFF; }
.glow-red { box-shadow:0 0 20px #f00,0 0 40px #f00,0 0 60px #f00; }
.glow-orange { box-shadow:0 0 20px #f90,0 0 40px #f90,0 0 60px #f90; }
.glow-green { box-shadow:0 0 20px #0f0,0 0 40px #0f0,0 0 60px #0f0; }
</style>
</head>
<body>
<div class="container">
<h1><span class="diamond">‚≠ê</span> Calculadora Brawl Stars <span class="diamond">‚≠ê</span></h1>
<form id="calcForm">
<label>üéüÔ∏è Brawl Pass: <input type="number" id="bpass" value="0"></label>
<label>ü©µ Comunes: <input type="number" id="comunes" value="0"></label>
<label>üíö Raras: <input type="number" id="raras" value="0"></label>
<label>üíú √âpicas: <input type="number" id="epicas" value="0"></label>
<label>‚ù§Ô∏è M√≠ticas: <input type="number" id="miticas" value="0"></label>
<label>üåü Legendarias: <input type="number" id="legendarias" value="0"></label>
<label>‚ö° Hipercarga: <input type="number" id="hipercarga" value="0"></label>
<label>üî• Maxeados: <input type="number" id="maxeados" value="0"></label>
<button type="button" id="infoBtn">INFO</button>
</form>
<div id="resultado">Valor total: 0 ü™ô</div>
<div class="buttons">
<button id="calcBtn">Calcular</button>
<button id="clearBtn">Limpiar</button>
</div>
<button id="shareBtn">üì§ Compartir</button>
<button id="spinBtn">üé≤ Girar Brawler</button>
<div style="position:relative; display:inline-block;">
<canvas id="myChart" width="400" height="400"></canvas>
<div id="centerDiamond">
<img id="brawlerImg" src="" alt="Brawler">
</div>
</div>
<div id="infoModal">
<div class="content">
<span id="infoClose">√ó</span>
<h3>Informaci√≥n</h3>
<p>Esta es tu calculadora de Brawl Stars. Ajusta los valores y gira la ruleta para ver tu Brawler del d√≠a.</p>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

document.addEventListener('DOMContentLoaded', () => {
  const supabase = createClient(
    'https://ttkneykkrkbajymzsgcr.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0a25leWtrcmtiYWp5bXpzZ2NyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5OTAyMjIsImV4cCI6MjA3MTU2NjIyMn0.Zsqy_PZ6K-3iTjh7nkTyH-7M9gOnSFHt4f0p9y_WPiE'
  );
  const PAGE_ID = 'pagina1';

  const calcBtn = document.getElementById('calcBtn');
  const clearBtn = document.getElementById('clearBtn');
  const shareBtn = document.getElementById('shareBtn');
  const spinBtn = document.getElementById('spinBtn');
  const infoBtn = document.getElementById('infoBtn');
  const infoModal = document.getElementById('infoModal');
  const infoClose = document.getElementById('infoClose');
  const brawlerImg = document.getElementById('brawlerImg');

  /* ==== UTILIDADES ==== */
  function beep(freq){
    const ctx = new (AudioContext||webkitAudioContext)(),
          o = ctx.createOscillator(),
          g = ctx.createGain();
    o.type="square";
    o.frequency.value=freq;
    o.connect(g);
    g.connect(ctx.destination);
    g.gain.setValueAtTime(.15,ctx.currentTime);
    o.start();
    o.stop(ctx.currentTime+.15);
  }
  function vibrar(ms=80){ if(navigator.vibrate) navigator.vibrate(ms); }

  /* ==== METRICAS ==== */
  async function cargarMetricas(){
    const { data, error } = await supabase.from('metrics').select('visitas,likes,dislikes').eq('page_id', PAGE_ID).single();
    if (!error && data){
      animateCounter('visitas-counter', data.visitas);
      animateCounter('likes-counter', data.likes);
      animateCounter('dislikes-counter', data.dislikes);
    }
  }
  async function incrementarVisita(){
    try{
      await supabase.rpc('increment_visitas',{pid: PAGE_ID});
      await cargarMetricas();
    }catch(e){ console.error(e); }
  }
  function animateCounter(id, value){
    const el = document.getElementById(id);
    let start = parseInt(el.innerText)||0;
    const end = Number(value)||0;
    const duration = 800;
    const t0 = performance.now();
    function step(t){
      const p = Math.min((t-t0)/duration,1);
      el.innerText = Math.floor(start + (end-start)*p);
      if(p<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  /* ==== BRAWLERS ==== */
  const allBrawlers = [
    "elprimo","colt","nita","edgar","spike","penny","darryl","rico","mortis","bea",
    "8-bit","alli","amber","angelo","ash","barley","belle","berry","bibi","bo","bonnie",
    "brock","bull","buster","buzz","byron","carl","charly","chester","chuck","clancy",
    "colette","cordelius","crow","doug","draco","dynamike","eve","fang","finx","frank",
    "gale","genio","gray","griff","grom","hank","gus","jacky","jae-yong","janet","jessie",
    "max","meeple","meg","melodie","mico","moe","nani","otis","ollie","pam","pearl","piper",
    "poco","r-t","rosa","ruffs","sam","sandy","shade","shelly","sprout","squeak","stu",
    "surge","tick","trunk","willow"
  ];
  const baseURL = "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/";
  const brawlerCache = {};
  let brawlersReady = false;

  function precargarBrawlers(onComplete){
    let cargadas = 0;
    allBrawlers.forEach(name => {
      const img = new Image();
      img.src = baseURL + name + ".png";
      img.onload = () => {
        cargadas++;
        if(cargadas === allBrawlers.length){
          brawlersReady = true;
          if(typeof onComplete === "function") onComplete();
        }
      };
      brawlerCache[name] = img;
    });
  }
  precargarBrawlers(() => {
    console.log("‚úÖ Todas las im√°genes precargadas. Ruleta lista.");
    brawlerImg.src = brawlerCache[allBrawlers[getDailyIndex(allBrawlers.length)]].src;
  });
  /* ===== CALCULAR ===== */
  function calcular(){
    beep(600); vibrar();
    calcBtn.classList.add('flash'); setTimeout(()=>calcBtn.classList.remove('flash'),200);

    const bpass = Number(document.getElementById("bpass").value)||0;
    const comunes = Number(document.getElementById("comunes").value)||0;
    const raras = Number(document.getElementById("raras").value)||0;
    const epicas = Number(document.getElementById("epicas").value)||0;
    const miticas = Number(document.getElementById("miticas").value)||0;
    const legendarias = Number(document.getElementById("legendarias").value)||0;
    const hipercarga = Number(document.getElementById("hipercarga").value)||0;
    const maxeados = Number(document.getElementById("maxeados").value)||0;

    const valores = {
      "üéüÔ∏è Brawl Pass": bpass*10,
      "ü©µ Comunes": comunes*2,
      "üíö Raras": raras*5,
      "üíú √âpicas": epicas*10,
      "‚ù§Ô∏è M√≠ticas": miticas*12,
      "üåü Legendarias": legendarias*15,
      "‚ö° Hipercarga": hipercarga*20,
      "üî• Maxeados": maxeados*50
    };

    const total = Object.values(valores).reduce((a,b)=>a+b,0);

    const resultadoEl = document.getElementById("resultado");
    let start = parseInt(resultadoEl.innerText.replace(/\D/g,''))||0;
    const end = total;
    const duration = 800;
    const t0 = performance.now();
    function step(t){
      const p = Math.min((t-t0)/duration,1);
      resultadoEl.innerText = "Valor total: "+Math.floor(start + (end-start)*p)+" ü™ô";
      if(p<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);

    const data = {
      labels: Object.keys(valores),
      datasets:[{
        data: Object.values(valores),
        backgroundColor:["#00FFFF","#00FF00","#FF00FF","#FFFF00","#FF4500","#00CFFF","#FF69B4","#FF0000"],
        borderWidth:2
      }]
    };
    const config = { type:'doughnut', data:data, options:{ cutout:"70%", plugins:{legend:{display:true,position:'bottom'}} }};
    if(chart) chart.destroy();
    chart = new Chart(document.getElementById('myChart').getContext('2d'), config);

    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    document.getElementById('centerDiamond').style.display="block";
    document.getElementById('myChart').scrollIntoView({behavior:'smooth', block:'center'});
  }

  /* ===== LIMPIAR ===== */
  function limpiar(){
    beep(300); vibrar();
    clearBtn.classList.add('flash'); setTimeout(()=>clearBtn.classList.remove('flash'),200);
    document.getElementById("calcForm").reset();
    document.getElementById("resultado").innerText="Valor total: 0 ü™ô";
    if(chart) chart.destroy();
  }

  /* ===== COMPARTIR ===== */
  async function share(){
    beep(500); vibrar(); shareBtn.classList.add('flash'); setTimeout(()=>shareBtn.classList.remove('flash'),200);
    const url = window.location.href;
    const text = "Mira cu√°nto valen mis Brawlers en Brawl Stars!";
    if(navigator.share){
      try{await navigator.share({title:"Calculadora Brawl Stars",text,url});}
      catch(err){console.log(err);}
    } else { alert("Tu navegador no soporta compartir nativo."); }
  }

  /* ===== BRAWLER DEL DIA ===== */
  function getDailyIndex(max){
    const uid = localStorage.getItem('uid')||Math.random().toString(36).slice(2,10);
    localStorage.setItem('uid', uid);
    const today = new Date().toISOString().slice(0,10);
    const saved = JSON.parse(localStorage.getItem('dailyBrawler')||'{}');
    if(saved.date===today && Number.isInteger(saved.index)) return saved.index;
    const idx = Math.floor(Math.random()*max);
    localStorage.setItem('dailyBrawler', JSON.stringify({date: today, index: idx}));
    return idx;
  }

  /* ===== SPIN SUAVE CON FRENADO Y GLOW LENTO ===== */
  function spinRouletteSmooth(){
    if(!brawlersReady) {
        alert("‚è≥ Las im√°genes a√∫n se est√°n cargando. Espera unos segundos.");
        return;
    }

    const finalIndex = getDailyIndex(allBrawlers.length);
    const glowClasses = ["glow-blue","glow-red","glow-orange","glow-green"];
    const totalBrawlers = allBrawlers.length;

    // Fase 1: Giro r√°pido
    let fastFrames = 40; // frames r√°pidos iniciales
    let currentIdx = 0;

    function fastSpin(){
        currentIdx = (currentIdx + 1) % totalBrawlers;
        brawlerImg.src = brawlerCache[allBrawlers[currentIdx]].src;
        fastFrames--;
        if(fastFrames > 0){
            requestAnimationFrame(fastSpin);
        } else {
            slowDownPhase();
        }
    }

    // Fase 2: Frenado con glow
    function slowDownPhase(){
        const lastSteps = 4; // √∫ltimos 4 pasos con glow
        const stepTime = 3000; // ms por glow
        const startIdx = (currentIdx + 1) % totalBrawlers;

        let step = 0;

        function nextStep(){
            if(step < lastSteps){
                const idx = (startIdx + step) % totalBrawlers;
                brawlerImg.src = brawlerCache[allBrawlers[idx]].src;

                // Glow correspondiente
                brawlerImg.classList.remove(...glowClasses);
                brawlerImg.classList.add(glowClasses[step]);

                step++;
                setTimeout(nextStep, stepTime);
            } else {
                // Paso final: Brawler del d√≠a
                brawlerImg.src = brawlerCache[allBrawlers[finalIndex]].src;
                brawlerImg.classList.remove(...glowClasses);
                brawlerImg.classList.add(glowClasses[3]); // Glow final
            }
        }

        nextStep();
    }

    fastSpin();
  }
  /* ===== EVENT LISTENERS ===== */
  document.addEventListener('DOMContentLoaded', () => {
    // Botones principales
    calcBtn.addEventListener('click', () => { beep(520); vibrar(80); calcular(); spinRouletteSmooth(); });
    clearBtn.addEventListener('click', limpiar);
    shareBtn.addEventListener('click', share);
    spinBtn.addEventListener('click', () => { beep(520); vibrar(80); spinRouletteSmooth(); });
    infoBtn.addEventListener('click', ()=> infoModal.style.display='flex');
    infoClose.addEventListener('click', ()=> infoModal.style.display='none');
    infoModal.addEventListener('click', e => { if(e.target===infoModal) infoModal.style.display='none'; });

    // Animaci√≥n de compartir
    shareBtn.classList.add('pulse');

    /* ===== METRICAS ===== */
    async function cargarMetricas(){
      const { data, error } = await supabase
        .from('metrics')
        .select('visitas,likes,dislikes')
        .eq('page_id', PAGE_ID)
        .single();
      if (!error && data){
        animateCounter('visitas-counter', data.visitas);
        animateCounter('likes-counter', data.likes);
        animateCounter('dislikes-counter', data.dislikes);
      }
    }

    async function incrementarVisita(){
      try{
        await supabase.rpc('increment_visitas',{pid: PAGE_ID});
        await cargarMetricas();
      }catch(e){ console.error(e); }
    }

    function animateCounter(id, value){
      const el = document.getElementById(id);
      let start = parseInt(el.innerText)||0;
      const end = Number(value)||0;
      const duration = 800;
      const t0 = performance.now();
      function step(t){
        const p = Math.min((t-t0)/duration,1);
        el.innerText = Math.floor(start + (end-start)*p);
        if(p<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    /* ===== INICIALIZACI√ìN ===== */
    (async ()=>{
      await incrementarVisita();
      await cargarMetricas();
      // La ruleta solo gira al pulsar botones
    })();
  });
  </script>
</body>
</html>
