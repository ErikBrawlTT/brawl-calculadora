<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calculadora Brawl Stars</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<style>
/* ======== ESTILO ORIGINAL + AJUSTES ======== */
body {
  margin: 0;
  font-family: 'Bangers', cursive;
  background: url('Personajes-Brawl-Stars.webp') no-repeat center center fixed;
  background-size: cover;
  color: white;
  text-align: center;
  position: relative;
}
body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);
  z-index: 0;
}
.container {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 20px;
}
h1 {
  font-size: 3rem;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: transparent;
  background: linear-gradient(90deg, #00FFAA, #00CFFF, #FF00FF);
  -webkit-background-clip: text;
}
h1 .diamond { animation: glow 3s infinite alternate; }
@keyframes glow {
  0% { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
  50% { text-shadow: 0 0 15px rgba(255,255,255,1); }
  100% { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
}

/* Resultado ARRIBA, centrado y fuera del form */
#resultado {
  margin: 8px 0 14px 0;
  font-size: 2rem;
  font-family: 'Bangers', cursive;
  padding: 10px 20px;
  background: rgba(0,0,0,0.7);
  border: 2px solid #00FF00;
  border-radius: 12px;
  color: #00FF00;
  text-shadow: 0 0 10px #00FF00, 0 0 20px #00FF00;
}

form {
  background: rgba(0,0,0,0.5);
  border-radius: 60px;
  padding: 20px;
  max-width: 600px;
  width:90%;
  margin-bottom: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
label {
  display:flex;
  justify-content:space-between;
  margin:8px 0;
  width:100%;
}
input {
  width:100px;
  text-align:center;
  border:none;
  border-radius:8px;
}

.buttons {
  display:flex;
  justify-content:center;
  gap:25px;
  margin-top:10px;
}
button {
  padding:10px 20px;
  border:none;
  border-radius:12px;
  font-family:'Bangers';
  font-size:1.5rem;
  color:white;
  cursor:pointer;
  transition: transform .12s ease, filter .12s ease;
}
#calcBtn {background:linear-gradient(90deg,#ff0080,#7928ca);}
#clearBtn{background:linear-gradient(90deg,#00CFFF,#0077FF);}
#shareBtn{
  background:linear-gradient(90deg,#00FFAA,#FF00FF);
  margin-top:12px;
  animation:pulse 1.2s infinite;
  color:#fff; /* letras blancas */
}
button:active{ transform:scale(0.96); filter:brightness(1.3); }
@keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.06)} 100%{transform:scale(1)} }

/* ===== CONTADORES NEON üëÄ üëç üëé ===== */
.metric-container {
  display: flex;
  justify-content: center;
  gap: 22px;
  margin-top: 16px;
}
.metric {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  font-family:'Orbitron', sans-serif;
}
.metric .icon {
  font-size: 1.8rem;
  line-height: 1;
}
.metric .box {
  background: rgba(0,0,0,0.7);
  padding: 8px 18px;
  border-radius: 12px;
  min-width: 78px;
  text-align: center;
  font-weight: 700;
  font-size: 2rem;
  user-select: none;
  transition: transform .08s ease, box-shadow .15s ease;
}
.metric .box:active { transform: scale(0.98); }

/* üëÄ azul neon */
.metric.visitas .box {
  border: 2px solid #00CFFF;
  color: #00CFFF;
  box-shadow: 0 0 8px #00CFFF, 0 0 16px #00CFFF;
}
/* üëç verde neon */
.metric.likes .box {
  border: 2px solid #39ff14;
  color: #39ff14;
  box-shadow: 0 0 8px #39ff14, 0 0 16px #39ff14;
  cursor: pointer;
}
/* üëé rojo neon */
.metric.dislikes .box {
  border: 2px solid #FF073A;
  color: #FF073A;
  box-shadow: 0 0 8px #FF073A, 0 0 16px #FF073A;
  cursor: pointer;
}

canvas{
  margin-top:15px;
  max-width:400px;
  position:relative;
}

/* Brawler central */
#centerDiamond {
  position: absolute;
  top: 43%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: none;
}
#centerDiamond img {
  width: 210px;
  height: 210px;
  border-radius: 50%;
  object-fit: contain;
  background: rgba(0,0,0,0.3);
}
</style>
</head>
<body>
<div class="container">
  <h1><span class="diamond">üíé</span> Calculadora Brawl Stars <span class="diamond">üíé</span></h1>

  <!-- Barra de resultado ARRIBA, fuera del form y encima de los botones -->
  <div id="resultado">Valor total: 0 ‚Ç¨</div>

  <form id="calcForm">
    <label>üéüÔ∏è Brawl Pass: <input type="number" id="bpass" value="0" min="0"></label>
    <label>ü©µ Comunes: <input type="number" id="comunes" value="0" min="0"></label>
    <label>üíö Raras: <input type="number" id="raras" value="0" min="0"></label>
    <label>üíú √âpicas: <input type="number" id="epicas" value="0" min="0"></label>
    <label>‚ù§Ô∏è M√≠ticas: <input type="number" id="miticas" value="0" min="0"></label>
    <label>üåü Legendarias: <input type="number" id="legendarias" value="0" min="0"></label>
    <label>‚ö° Hipercarga: <input type="number" id="hipercarga" value="0" min="0"></label>
    <label>üî• Maxeados: <input type="number" id="maxeados" value="0" min="0"></label>
  </form>

  <div class="buttons">
    <button id="calcBtn">Calcular</button>
    <button id="clearBtn">Limpiar</button>
  </div>
  <button id="shareBtn">üì§ Compartir</button>

  <!-- Contadores neon -->
  <div class="metric-container">
    <div class="metric visitas">
      <span class="icon">üëÄ</span>
      <div class="box" id="visitas-counter">0</div>
    </div>
    <div class="metric likes">
      <span class="icon">üëç</span>
      <div class="box" id="likes-counter">0</div>
    </div>
    <div class="metric dislikes">
      <span class="icon">üëé</span>
      <div class="box" id="dislikes-counter">0</div>
    </div>
  </div>

  <div style="position:relative; display:inline-block;">
    <canvas id="myChart" width="400" height="400"></canvas>
    <div id="centerDiamond">
      <img id="brawlerImg" src="https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/elprimo.png" alt="Brawler">
    </div>
  </div>
</div>

<!-- JS en m√≥dulo para usar Supabase ESM -->
<script type="module">
/* ===== Supabase ===== */
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://ttkneykkrkbajymzsgcr.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0a25leWtrcmtiYWp5bXpzZ2NyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5OTAyMjIsImV4cCI6MjA3MTU2NjIyMn0.Zsqy_PZ6K-3iTjh7nkTyH-7M9gOnSFHt4f0p9y_WPiE'
);
const PAGE_ID = 'pagina1';

/* ===== Utilidades de sonido y vibraci√≥n (distintos tonos) ===== */
function beep(freq=600, ms=150, gain=0.15){
  const Ctx = window.AudioContext || window.webkitAudioContext;
  const ctx = new Ctx();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "square";
  o.frequency.value = freq;
  o.connect(g);
  g.connect(ctx.destination);
  g.gain.setValueAtTime(gain, ctx.currentTime);
  o.start();
  o.stop(ctx.currentTime + ms/1000);
}
function vibrar(ms=80){ if(navigator.vibrate) navigator.vibrate(ms); }

/* ===== Animaci√≥n digital de los contadores ===== */
function animateCounter(id, value){
  const el = document.getElementById(id);
  let start = parseInt(el.innerText || '0',10);
  const end = Number(value)||0;
  const duration = 700;
  const t0 = performance.now();

  function step(t){
    const p = Math.min((t - t0) / duration, 1);
    const v = Math.floor(start + (end - start) * p);
    el.innerText = v.toString();
    if (p < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ===== Cargar m√©tricas ===== */
async function cargarMetricas(){
  const { data, error } = await supabase
    .from('metrics')
    .select('visitas,likes,dislikes')
    .eq('page_id', PAGE_ID)
    .single();
  if (error) { console.error('Error al cargar m√©tricas:', error); return; }
  animateCounter('visitas-counter', data.visitas);
  animateCounter('likes-counter', data.likes);
  animateCounter('dislikes-counter', data.dislikes);
}

/* ===== Incrementar visita al entrar ===== */
async function incrementarVisita(){
  try {
    const { error } = await supabase.rpc('increment_visitas', { pid: PAGE_ID });
    if (error) throw error;
    await cargarMetricas();
  } catch(e) {
    console.error('Error incrementando visita:', e);
  }
}

/* ===== Voto con rectificaci√≥n (1 vez por sesi√≥n) ===== */
async function votar(tipo){
  const prev = localStorage.getItem('vote'); // 'like' | 'dislike' | null
  try{
    if (prev === tipo) return; // nada que cambiar
    if (prev === 'like' && tipo === 'dislike'){
      await supabase.rpc('decrement_likes', { pid: PAGE_ID });
      await supabase.rpc('increment_dislikes', { pid: PAGE_ID });
    } else if (prev === 'dislike' && tipo === 'like'){
      await supabase.rpc('decrement_dislikes', { pid: PAGE_ID });
      await supabase.rpc('increment_likes', { pid: PAGE_ID });
    } else if (!prev && tipo === 'like'){
      await supabase.rpc('increment_likes', { pid: PAGE_ID });
    } else if (!prev && tipo === 'dislike'){
      await supabase.rpc('increment_dislikes', { pid: PAGE_ID });
    }
    localStorage.setItem('vote', tipo);
    await cargarMetricas();
  }catch(e){
    console.error('Error al votar:', e);
  }
}

/* Click en cajas üëç üëé */
document.getElementById('likes-counter').parentElement.addEventListener('click', ()=>{
  beep(720,140,0.12); vibrar(60);
  votar('like');
});
document.getElementById('dislikes-counter').parentElement.addEventListener('click', ()=>{
  beep(320,140,0.12); vibrar(60);
  votar('dislike');
});

/* ====== TU L√ìGICA ORIGINAL: confeti, c√°lculo, gr√°fico ====== */
function lanzarConfeti() {
  const duration = 4000;
  const end = Date.now() + duration;
  (function frame() {
    confetti({
      particleCount: 10,
      startVelocity: 3,
      gravity: 0.25,
      spread: 360,
      ticks: 200,
      origin: { x: Math.random(), y: Math.random() * 0.4 },
      colors: ['#ff00ff','#00ffff','#00ff00','#ffff00','#ff0000','#00CFFF']
    });
    if (Date.now() < end) requestAnimationFrame(frame);
  })();
}

function animateNumber(finalValue){
  const resultado = document.getElementById("resultado");
  const start=0,duration=2000,startTime=performance.now();
  function step(now){
    const p=Math.min((now-startTime)/duration,1);
    resultado.innerText="Valor total: "+Math.floor(start+(finalValue-start)*p)+" ‚Ç¨";
    if(p<1)requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

let chart;
function calcular(){
  beep(600,150,0.15); vibrar(80);
  const bpass = +document.getElementById("bpass").value || 0;
  const comunes = +document.getElementById("comunes").value || 0;
  const raras = +document.getElementById("raras").value || 0;
  const epicas = +document.getElementById("epicas").value || 0;
  const miticas = +document.getElementById("miticas").value || 0;
  const legendarias = +document.getElementById("legendarias").value || 0;
  const hipercarga = +document.getElementById("hipercarga").value || 0;
  const maxeados = +document.getElementById("maxeados").value || 0;

  const valores={
    "üéüÔ∏è Brawl Pass":bpass*10,
    "ü©µ Comunes":comunes*2,
    "üíö Raras":raras*5,
    "üíú √âpicas":epicas*10,
    "‚ù§Ô∏è M√≠ticas":miticas*12,
    "üåü Legendarias":legendarias*15,
    "‚ö° Hipercarga":hipercarga*20,
    "üî• Maxeados":maxeados*50
  };
  const total = Object.values(valores).reduce((a,b)=>a+b,0);
  animateNumber(total);

  document.getElementById("centerDiamond").style.display = "block";

  const data={
    labels:Object.keys(valores),
    datasets:[{
      data:Object.values(valores),
      backgroundColor:[
        "#00FFFF", "#00FF00", "#FF00FF", "#FFFF00",
        "#FF4500", "#00CFFF", "#FF69B4", "#FF0000"
      ],
      borderWidth:2
    }]
  };
  const config={
    type:'doughnut',
    data:data,
    options:{ cutout:"70%", plugins:{legend:{display:true,position:'bottom'}} }
  };

  if(chart){chart.destroy();}
  const ctx = document.getElementById('myChart').getContext('2d');
  chart = new Chart(ctx,config);

  lanzarConfeti();
  document.getElementById('myChart').scrollIntoView({behavior:'smooth', block:'center'});
}

/* Limpiar */
function limpiar(){
  beep(420,140,0.12); vibrar(50);
  document.getElementById("calcForm").reset();
  document.getElementById("resultado").innerText="Valor total: 0 ‚Ç¨";
  if(chart){chart.destroy();}
  document.getElementById("centerDiamond").style.display="none";
}

/* Compartir */
document.getElementById("shareBtn").addEventListener("click", async () => {
  beep(800,120,0.12); vibrar(40);
  const url = window.location.href;
  const text = "Mira cu√°nto valen mis Brawlers en Brawl Stars!";
  if (navigator.share) {
    try { await navigator.share({ title: "Calculadora Brawl Stars", text, url }); }
    catch (err) { console.log("Cancelado", err); }
  } else {
    alert("Tu navegador no soporta compartir nativo.\nCopia este enlace:\n" + url);
  }
});

/* Eventos botones */
document.getElementById("calcBtn").addEventListener("click",calcular);
document.getElementById("clearBtn").addEventListener("click",limpiar);

/* Brawler rotando en el centro cada 3s */
const brawlers = [
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/elprimo.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/colt.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/nita.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/edgar.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/spike.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/penny.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/darryl.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/rico.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/mortis.png",
  "https://raw.githubusercontent.com/ErikBrawlTT/brawl-calculadora/main/Brawlers/bea.png"
];
let current = 0;
const brawlerImg = document.getElementById("brawlerImg");
document.getElementById("centerDiamond").style.display = "block";
setInterval(() => {
  current = (current + 1) % brawlers.length;
  brawlerImg.src = brawlers[current];
}, 3000);

/* Arranque: suma visita y pinta contadores */
await incrementarVisita();
await cargarMetricas();
</script>
</body>
</html>
